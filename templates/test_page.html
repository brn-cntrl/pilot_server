<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testing Page</title>
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>

<body>
    <h1>Experiment</h1>
    
    <div id="Instructions">
        <h2>Tasks</h2>
        <p>Press the button to start the first test then solve the subtraction problems. <b>Please speak each answer aloud.</b></p>
        <ul>
            <li>Time: You have 5 minutes to complete the task.</li>
            <li>+10 cents for each correct answer.</li>
            <li>-15 cents for each wrong answer.</li>
            <li>Double your earnings after 20 correct answers.</li>
            <li>Total: You can see your total money earned or lost during the task.</li>
            <li>Submit your balance when you are finished by clicking "Upload Balance"</li>
            <li>Payment: We will Venmo you the amount you earn at the end.</li>
        </ul>
    </div><br>
    <button id="startTestButton" style="display:none;">Start Test 1</button> <br>
    <div class="testModule">
        <p id="loadingMessage"></p>
        <div id="clock">05:00</div><br><br>
        <div id="accountBalance">$0</div><br><br>
        <div id="test_container"></div> <br>
    
        <button id="submitAnswerButton" disabled>Submit Answer</button> <br>
        <button id="uploadBalance" disabled>Upload Balance</button>
        <p id="result"></p> <br>
        <p id="status"></p><br><br>
    </div>
    
    <script>
        let testNumber; // NOTE: testNumber is set with test_manager.current_test_index which starts at 0.
        let startTime;
        let elapsedTime = 0;
        let initialTime = 300;  // 5 minutes
        let timeLeft = initialTime;
        let timerInterval;
        let account = .00;

        const timeDisplay = document.getElementById('clock');
        const startTestButton = document.getElementById('startTestButton');
        const submitAnswerButton = document.getElementById('submitAnswerButton');
        const testContainer = document.getElementById('test_container');
        const loadingMessage = document.getElementById('loadingMessage');
        const statusContainer = document.getElementById('status');
        const accountBalance = document.getElementById('accountBalance');
        const clock = document.getElementById('clock');
        const result = document.getElementById('result');
        const uploadBalance = document.getElementById('uploadBalance');

        function getNextTest(){
            fetch('/get_next_test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                testNumber = data.test_number;
                console.log("Test Number: ", testNumber);
                console.log(data.message);
            });
        }
        
        function startClock() { 
            if(!timerInterval) {
                timerInterval = setInterval(updateClock, 1000);
            }
        }

        function stopClock() {
            clearInterval(timerInterval); 
            timerInterval = null;
        }
                
        function resetClock(){
            stopClock();
            timeLeft = initialTime;
            timerDisplay.textContent = '05:00';
        }

        function updateClock() {
            let minutes = Math.floor(timeLeft / 60);
            let seconds = timeLeft % 60;
            seconds = seconds < 10 ? '0' + seconds : seconds;
            timeDisplay.textContent = `${minutes}:${seconds}`;
            playTickSound();
            timeLeft--;
            if(timeLeft < 0) {
                clearInterval(timerInterval);
                statusContainer.innerText = 'Time is up!';
                endTest();
            }
        }

        function endTest() {
            submitAnswerButton.style.display = 'none';
            submitAnswerButton.disabled = true;

            if (testNumber === 0){
                statusContainer.innerText = 'Test completed! Please perform the next activity before starting the next test.';
                startTestButton.style.display = 'block';
                startTestButton.disabled = false;
                clock.innerText = '05:00';
            } else if (testNumber === 0){
                statusContainer.innerText = 'All tests completed! Thank you for participating in the experiment.';
                startTestButton.style.display = 'none';
                startTestButton.disabled = true;
                clock.innerText = '00:00';
            }
        }

        async function submitAnswer() {
            statusContainer.innerText = "Analyzing Answer...";
            submitAnswerButton.disabled = true;
            try {
                const response = await fetch('/submit_answer', { method: 'POST' });
                const data = await response.json();
                statusContainer.innerText = data.result;

                if (data.result === 'correct') {
                    account += 0.10;
                    accountBalance.innerText = `$${account.toFixed(2)}`;
                } else if (data.result === 'incorrect') {
                    account -= 0.15;
                    accountBalance.innerText = `$${account.toFixed(2)}`;
                }

                if (data.result === 'correct' || data.result === 'incorrect') {
                    await getNextQuestion(); 
                    submitAnswerButton.disabled = false;

                } else if (data.result === 'error') {
                    statusContainer.innerText = "Sorry, I could not understand the response.";
                    submitAnswerButton.disabled = false;

                    stopClock();
                    await startRecording();
                    submitAnswerButton.disabled = false;
                    startClock();

                } else if (data.result === 'test_completed') {
                    submitAnswerButton.style.display = 'none';
                    startTestButton.style.display = 'none';
                    statusContainer.innerText = 'Test completed!';
                    stopClock();
                    resetClock();
                } 
            } catch (error) {
                    console.error('Error:', error);
            }       
        }
    
        document.addEventListener('DOMContentLoaded', (event) => {
            fetch('/get_current_test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                testNumber = data.test_number;
                console.log("Test Number: ", testNumber);
                console.log(data.message);
            })
            .catch(error => {
                console.error('Error:', error);
            });

            startTestButton.style.display = 'block';
            submitAnswerButton.disabled = true;
            loadingMessage.style.display = 'none';
            accountBalance.innerText = `$00.0${account}`;
        });
    
        document.addEventListener('DOMContentLoaded', (event) => {
            startTestButton.addEventListener('click', function() {
                submitAnswerButton.disabled = true;
                loadingMessage.style.display = 'block';
                uploadBalance.disabled = true;
                statusContainer.innerText = '';

                startRecording()
                    .then(() => {
                        return fetch('/get_question', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        testNumber = data.test_number;

                        loadingMessage.style.display = 'none';
                        startTestButton.disabled = true;
                        testContainer.innerHTML = `
                            <h2>Test</h2>
                            <div id="questionsContainer">${data.question}</div>
                        `;

                        let checkInterval = setInterval(() => {
                            if (checkActiveStream()) {
                                console.log("Stream is active.");
                                testContainer.style.display = 'block';
                                submitAnswer.disabled = false;
                                startClock();
                                clearInterval(checkInterval); 
                            } else {
                                console.log("Stream is not active yet, checking again...");
                                testContainer.style.display = 'none';
                                submitAnswer.disabled = true;
                            }
                        }, 2000); 
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to start test.');
                    });
            });
        });
    
        submitAnswerButton.addEventListener('click', function() {
            submitAnswer();
        });

        uploadBalance.addEventListener('click', function() {
            fetch('/submit_final_balance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ balance: account.toFixed(2) })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                result.innerText = data.message;
            })
            .catch(error => console.error('Error:', error));
        });
    </script>
</body>
</html> 