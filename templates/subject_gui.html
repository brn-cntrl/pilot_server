<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subject Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <h1>Subject Dashboard</h1>
    <p>Please fill out each section in order. When each task is complete, a new one will appear until the experiment is completed.</p>
    <div id="pretestDiv">
        <h2>Pretest</h2>
        <p>The following is a set of pretest procedures including surveys and baseline data collection. Please complete each as instructed by the test supervisor.</p>
        <button class="toggle">Surveys</button><br>
        <div class="testModule" style="display:block;">
            <h2>Participant Information</h2>
            <ul>
                <li>Before performing the tasks, please fill out the following information form.</li>
                <li>Names will be obfuscated to ensure the privacy of subject data</li>
            </ul>

            <button class="toggle">Participant Information</button><br>
            <div class="innerModule" style="display:block;">
                <form action="/submit" method="POST" id="nameForm">
                    <label for="first_name">First Name:</label>
                    <input type="text" id="first_name" name="first_name" required><br><br>
                    <label for="last_name">Last Name:</label>
                    <input type="text" id="last_name" name="last_name" required><br><br>
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required><br><br>
                    <p>Please fill out the following information. If not applicable, please write "N/A" in each field:</p>
                    <label for="PID">PID:<span class="required">*</span></label>
                    <input type="text" id="PID" name="PID"><br><br>
                    <label for="class">Class you will assigning SONA credit to:<span class="required">*</span></label>
                    <input type="text" id="class" name="class"><br><br>
                    <button type="submit" id="submitButton">Submit Information</button>
                </form><br>
                <div id="notification1" style="display:none; color: green;">Form submitted successfully!</div>
                <div id="errorNotification1" style="display:none; color: red;">Error submitting form.</div><br>
                <button class="taskComplete">Task Complete</button>
            </div>
        </div><br>

        <button class="toggle nextButton" style="display:none;">Device Setup</button>
        <div class="testModule nextDiv" style="display:none;">
            <ul>
                <li>The experimenter will now help you with two devices needed to collect data for the session.</li>
            </ul>
            <button class="taskComplete">Task Complete</button>
        </div><br>

        <button class="toggle nextButton" style="display:none;">Demographics</button>
        <div class="testModule nextDiv" style="display:none;">
            <p>Please fill out this form.</p>
            <div id="demographicsDiv" style="display:block;"></div><br>
            <button class="taskComplete">Task Complete</button>
        </div><br>

        <button class="toggle nextButton" style="display:none;">Data Collection</button>
        <div class="testModule nextDiv" style="display:none;">
            <ul>
                <li>The experimenter will now begin collecting baseline data for the session.</li>
            </ul>
            <button class="taskComplete">Task Complete</button>
        </div><br>

        <button class="toggle nextButton" style="display:none;">Survey</button>
        <div class="testModule nextDiv" style="display:none;">
            <p>Please fill out this form.</p>
            <div id="pss4Div" style="display:none;"></div><br>
            <button class="taskComplete">Task Complete</button>
        </div><br>

        <button class="toggle nextButton" style="display:none;">Test Audio</button>
        <div class="testModule nextDiv" style="display:none;">
            <ul>
                <li>The experimenter will now place your headphones and attach a microphone to record audio for the session.</li>
                <li>The experimenter will then play three short tones to test your headphones</li>
                <li>The experimenter will then direct you to press "Record" to test your microphone</li>
                <li>After you press "Record", please read out loud the statement that appears below.</li>
            </ul><br>
            <button id="testAudio">Record</button><br>
            <p id="audioStatusMessage"></p>
            <button class="taskComplete">Task Complete</button>
        </div><br>

        <button class="toggle nextButton" style="display:none;">Mood Q&A</button>
        <div class="testModule nextDiv" style="display:none;">
            <ul>
                <li>Press "Begin"</li>
                <li>Read the first question when it appears</li>
                <li>Speak your answer aloud</li>
                <li>Press "Submit" to register your answer and receive the next question</li>
            </ul> <br>
            <button id="beginSERButton">Begin</button>
            <p id="status" style="display:none;" disabled></p>
            <p id="questionContainer" style="display:none;" disabled></p>
            <button id="submitAnswer" style="display:none;" disabled>Submit Answer</button><br><br>
            <button class="taskComplete">Task Complete</button>
        </div><br>
    </div>

    <button class="toggle nextButton" style="display:none;">Experimental Tasks</button>
    <div class="nextDiv" style="display:none;">
        <h2 >Experimental Tasks</h2>
        <p>The following is a set of experimental tasks to be completed.</p>
        <p>After completing a task, please wait for instructions before advancing to the next task.</p>
        
        <div class="testModule" style="display:block;">
            <button class="toggle">Test 1</button>
            <div class="innerModule" style="display:none;">
                <button class="openStressTask">Go to Test 1</button><br><br>
                <button class="taskComplete">Task Complete</button><br>
            </div><br>
            
            <button class="toggle nextButton" style="display:none;">Screen / VR Task 1</button>
            <div class="innerModule nextDiv" style="display:none;">
                <p>The test supervisor will now assist you with the VR headset.</p> 
                <button class="taskComplete">Task Complete</button>
            </div><br>
            
            <button class="toggle nextButton" style="display:none;">IAT Task 1</button>
            <div class="innerModule nextDiv" style="display:none;">
                <ul>
                    <li>The test supervisor will now assist you with the first IAT.</li>
                    <li>Complete the tasks as directed.</li>
                    <li>Press "Task Complete" when you have finished the task.</li>
                </ul>
                <button class="taskComplete">Task Complete</button>
            </div><br>

            <button class="toggle nextButton" style="display:none;">PRS Survey 1</button>
            <div class="innerModule nextDiv" style="display:none;">
                <ul>
                    <li>The test supervisor will now assist you with the next section of the test.</li>
                    <li>Please press "Task Complete" when you return</li>
                </ul>
                <button class="taskComplete">Task Complete</button>
            </div><br>  

            <button class="toggle nextButton" style="display:none;">Break 1</button>
            <div class="innerModule nextDiv" style="display:none;">
                <button class="breakButton">Take Break</button><br><br>
                <button class="taskComplete">Break Complete</button>
            </div><br>
            
            <button class="toggle nextButton" style="display:none;">Test 2</button>
            <div class="innerModule nextDiv" style="display:none;">
                <button class="openStressTask">Go to Test 2</button><br><br>
                <button class="taskComplete">Task Complete</button>
            </div><br>
            
            <button class="toggle nextButton" style="display:none;">Screen / VR Task 2</button>
            <div class="innerModule nextDiv" style="display:none;">
                <ul>
                    <li>The test supervisor will now assist you with the next section of the test.</li>
                    <li>Please press "Task Complete" when you return</li>
                </ul>
                <button class="taskComplete">Task Complete</button>
            </div><br>

            <button class="toggle nextButton" style="display:none;">IAT Task 2</button>
            <div class="innerModule nextDiv" style="display:none;">
                <ul>
                    <li>The test supervisor will now assist you with the second IAT.</li>
                    <li>Complete the tasks as directed.</li>
                    <li>Press "Task Complete" when you have finished the task.</li>
                </ul>
                <button class="taskComplete">Task Complete</button>
            </div><br>

            <button class="toggle nextButton" style="display:none;">PRS Task 2</button>
            <div class="innerModule nextDiv" style="display:none;">
                <ul>
                    <li>The test supervisor will now assist you with the next section of the test.</li>
                    <li>Please press "Task Complete" when you return</li>
                </ul>
                <button class="taskComplete">Task Complete</button>
            </div><br>

            <button class="toggle nextButton" style="display:none">Break 2</button>
            <div class="innerModule nextDiv" style="display:none;">
                <button class="breakButton">Take Break</button><br><br>
                <button class="taskComplete">Break Complete</button>
            </div>
        </div>
    </div><br>
    <button class="toggle nextButton" style="display:none;">Post Test</button>
    <div class="nextDiv" style="display:none;">
        <h2>Post Test</h2>
        <p>Please fill out the exit survey.</p>
        <div class="testModule" style="display:block;">
            <button class="toggle">Exit Survey</button>
            <div class="innerModule" id="exitSurveyDiv" style="display:none;"></div><br><br>
            <button class="taskComplete" id="postTestComplete">Task Complete</button><br>
            <p id="completeMessage" style="display:none;">All tasks are complete. Please wait for further instructions.</p>
        </div>
    </div>
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
    <script>
        const nameForm = document.getElementById('nameForm')
        const submitButton = document.getElementById('submitButton');
        const notification1 = document.getElementById('notification1');
        const errorNotification1 = document.getElementById('errorNotification1');
        const surveyStatus = document.getElementById('surveyStatus');
        const pss4Button = document.getElementById('pss4Button');
        const testAudio = document.getElementById('testAudio');
        const audioStatusMessage = document.getElementById('audioStatusMessage');
        const beginSERButton = document.getElementById('beginSERButton');
        const status = document.getElementById('status');
        const questionContainer = document.getElementById('questionContainer');
        const submitAnswer = document.getElementById('submitAnswer');
        const completeMessage = document.getElementById('completeMessage');
        const exitSurveyDiv = document.getElementById('exitSurveyDiv');
        const demographicsDiv = document.getElementById('demographicsDiv')

        let pss4;
        let exitSurvey;
        let demographics;
        let breakWin;
        let breakButtons = document.getElementsByClassName('breakButton');
        let stressButtons = document.getElementsByClassName('openStressTask');
        const pss4Div = document.getElementById('pss4Div');

        document.addEventListener('DOMContentLoaded', function(){
            for (let i = 0; i < breakButtons.length; i++) {
                breakButtons[i].addEventListener('click', function() {
                    breakWin = window.open('/break_page', '_blank', 'width=800, height=600');
                });
            }

            for (let i = 0; i < stressButtons.length; i++) {
                stressButtons[i].addEventListener('click', function() {
                    window.open('/test_page', '_blank', 'width=800, height=600');
                });
            }
        });
        
        // Resets emotion baseline question index to 0 when page is loaded
        window.onload = function(){
            fetch("/reset_ser_question_index", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => console.log(data.status))
            .catch(error => console.error('Error:', error));
        }

        document.addEventListener('DOMContentLoaded', function() { 
            postTestComplete.addEventListener('click', function(){
                completeMessage.style.display = 'block';
            });
        });
        
        document.querySelectorAll('.taskComplete').forEach(button => {
            button.addEventListener('click', function() {
                let nextButton = document.querySelector('.nextButton:not([style*="display: block"])');
                let nextDiv = document.querySelector('.nextDiv:not([style*="display: block"])');

                if (nextButton) nextButton.style.display = 'block';
                if (nextDiv) nextDiv.style.display = 'block';
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            nameForm.addEventListener('submit', function(event){
                event.preventDefault();
                const formData = new FormData(nameForm);
                fetch('/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams(formData).toString()
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message === 'Experiment and trial names must be set.' || data.message === "Invalid email address."){
                        notification1.style.display = "none";
                        errorNotification1.style.display = "block";
                        errorNotification1.innerHTML = data.message;
                        alert(data.message);
                    
                    } else {
                        notification1.style.display = 'block';
                        errorNotification1.style.display = 'none';
                        pss4 = data.pss4;
                        demographics = data.demographics;
                        exitSurvey = data.exit_survey;
                        pss4Div.innerHTML = `<iframe src="${pss4}" width="80%" height="600px" frameborder="0">Loading survey....</iframe>`;
                        pss4Div.style.display='block';
                        exitSurveyDiv.innerHTML = `<iframe src="${exitSurvey}" width="80%" height="600px" frameborder="0">Loading survey....</iframe>`;
                        exitSurveyDiv.style.display = 'block';
                        demographicsDiv.innerHTML = `<iframe src="${demographics}" width="80%" height="600px" frameborder="0">Loading survey....</iframe>`;
                    }
                })
                .catch((error) => {
                    notification1.style.display = 'none';
                    errorNotification1.style.display = 'block';
                    console.error('Error:', error);
                });
            })
        });

        beginSERButton.addEventListener('click', function() {
            beginSERButton.disabled = true;
            questionContainer.style.display = 'block';
            status.style.display = 'block';
            submitAnswer.style.display = 'block';
            submitAnswer.disabled = true; 
            
            status.innerText = "Please wait before responding...";
            setEventMarker('ser_baseline');
            startRecording()
                .then(() => {
                    submitAnswer.disabled = false;
                    status.innerText = "Recording... Please speak clearly. Press 'Submit Answer' when finished.";
                    fetchNextQuestion();  
                })
                .catch(error => {
                    console.error('Error starting audio stream:', error);
                    alert('Error starting audio stream: ' + error);
                });
        });

        submitAnswer.addEventListener('click', function() {
            submitAnswer.disabled = true;
            status.innerText = "Processing your answer...";
            
            fetch("/process_ser_answer", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'error') {
                    status.innerText = data.message;
                } else {
                    status.innerText = data.status;
                    console.log(data.message);
                    return startRecording(); 
                }
            })
            .then(() => {
                submitAnswer.disabled = false;
                status.style.display = 'none';;
                fetchNextQuestion(); 
            })
            .catch(error => {
                console.error('Error:', error);
                status.innerText = "Error occurred while processing the answer.";
            });
        });

        function fetchNextQuestion() {
            fetch('/get_ser_question', { method: 'GET' })
                .then(response => response.json())
                .then(data => {
                    if (data.message === 'SER task completed.') {
                        setEventMarker('subject_idle');
                        submitAnswer.disabled = true;
                        submitAnswer.style.display = 'none';
                        status.innerText = data.message;
                        questionContainer.innerText = "No more questions."
                    } else {
                        questionContainer.innerText = data.question;
                        console.log(data.question);
                    }
                })
                .catch(error => {
                    console.error('Error getting SER question:', error);
                    status.innerText = "Error occurred while getting the SER question.";
                });
        }

        testAudio.addEventListener('click', async function() {
            if (testAudio.innerText === 'Record') {
                audioStatusMessage.innerText = "Please wait...";
                startRecording()
                .then(() => {
                    audioStatusMessage.innerText = "Recording... Please say 'She sells seashells by the sea shore'. Press 'Stop' when finished.";
                    testAudio.innerText = 'Stop';      
                })
            }
            else if (testAudio.innerText === 'Stop') {
                try {
                    const response = await fetch('/test_audio', { method: 'POST' });
                    const data = await response.json();
                    audioStatusMessage.innerText = `I got: ${data.result}`;
                } catch (error) {
                    console.error('Error:', error);
                    audioStatusMessage.innerText = "Error occurred during recording or transcription.";
                } finally {
                    testAudio.innerText = 'Record';
                    audioTestComplete = true;
                }
            }
        });
    </script>
</body>
</html>