<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subject Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <h1>Subject Dashboard</h1>
    <p>Please fill out each section in order. When each task is complete, a new one will appear until the experiment is completed.</p>
    <div id="pretestDiv">
        <h2>Pretest</h2>
        <!-- <p>The following is a set of pretest procedures including surveys and baseline data collection. Please complete each as instructed by the test supervisor.</p> -->
        <button class="toggle">Surveys</button><br>
        <div class="testModule" style="display:block;">
            <h2>Participant Information</h2>
            <ul>
                <li>Before performing the tasks, please fill out the following information form.</li>
                <li>Names will be obfuscated to ensure the privacy of subject data</li>
            </ul>

            <button class="toggle">Participant Information</button><br>
            <div class="innerModule" style="display:block;">
                <form action="/submit" method="POST" id="nameForm" autocomplete="off">
                    <label for="first_name">First Name:</label>
                    <input type="text" id="first_name" name="first_name" required><br><br>
                    <label for="last_name">Last Name:</label>
                    <input type="text" id="last_name" name="last_name" required><br><br>
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required><br><br>
                    <label for="emailReenter">Re-enter Email:</label>
                    <input type="email" id="emailReenter" name="emailReenter" required><br><br>
                    <span id="noMatch" style="color: red; display: none;">Emails do not match.</span><br>
                    <!-- <p>Please fill out the following information. If not applicable, please write "N/A" in each field:</p> -->
                    <label for="PID">PID:<span class="required">*</span></label>
                    <input type="text" id="PID" name="PID"><br><br>
                    <label for="class">Class you will assigning SONA credit to:<span class="required">*</span></label>
                    <input type="text" id="class" name="class"><br><br>
                    <button type="submit" id="submitButton">Submit Information</button>
                </form><br>
                <div id="notification1" style="display:none; color: green;">Form submitted successfully!</div><br>
                <div id="errorNotification1" style="display:none; color: red;">Error submitting form.</div>
                <div id="deviceSetupDiv" style="display:none;">The experimenter will now help you with the devices needed to collect data for the session.</div>
            </div><br>

        <button class="toggle" id="survey1Button" style="display:none;">Survey 1</button>
        <div class="innerModule" id="survey1Div" style="display:none;">
            <p>Please fill out this form.</p>
            <div id="demographicsDiv" style="display:block;"></div><br>
            <button class="taskComplete" onclick="completeTask('survey_1')">Task Complete</button>
        </div><br>

        <button class="toggle nextButton" style="display:none;">Survey 2</button>
        <div class="innerModule nextDiv" style="display:none;">
            <p>Please fill out this form.</p>
            <div id="pss4Div" style="display:none;"></div><br>
            <button class="taskComplete" onclick="completeTask('survey_2')">Task Complete</button>
        </div><br>

        <button class="toggle nextButton" style="display:none;">Password</button>
        <div class="innerModule nextDiv" style="display:none;">
            <p>Thank you for filling out the pre-test information. Please let the experimenter know you have completed this section.</p>
            <form action="/submit_pwd" method="POST" id="experimenterPwd1" autocomplete="off">
                <label for="password">Password:</label>
                <input type="password" name="password" id="password"><br><br>
                <button type="submit">Submit Password</button>
            </form>
            <div id="pwdErrorNotification1" style="display:none; color: red;">Incorrect Password.</div><br>
        </div><br>
        
        <button class="toggle nextButton" style="display:none;">Test Transcription</button>
        <div class="innerModule nextDiv" style="display:none;">
            <ul>
                <li>Press "Record" to test your microphone</li>
                <li>After you press "Record", please read out loud the statement that appears below.</li>
            </ul><br>
            <p id="audioStatusMessage"></p>
            <button id="testAudio">Record</button><br><br>
            <button class="taskComplete" onclick="completeTask('test_transcription')">Task Complete</button>
        </div><br>

        <button class="toggle nextButton" style="display:none;">Mood Q&A</button>
        <div class="innerModule nextDiv" style="display:none;">
            <ul>
                <li>Press "Begin" to start recording</li>
                <li>Speak your answer to each question aloud</li>
                <li>Press "Submit" to register your answer and receive the next question</li>
            </ul> <br>
            <button id="beginSERButton">Begin</button>
            <p id="QAStatus" style="display:none;" disabled></p>
            <p id="questionContainer" style="display:none;" disabled></p>
            <button id="submitAnswer" style="display:none;" disabled>Submit Answer</button><br><br>
            <button id="serComplete" onclick="completeTask('ser_baseline')">Task Complete</button>
        </div><br>
    </div><br>

    <div id="mainTasksDiv" style="display:none;">
        <div class="testModule" style="display:block;">
            <p>After completing a task, please wait for instructions before advancing to the next task.</p>
            <button class="toggle">Test 1</button>
            <div class="innerModule" style="display:none;">
                <p>Instructions</p>
                <div><ul>
                    <li>Start with the number 1,009. For your first answer, subtract 13 from 1,009. Continue subtracting 13 from each new result until the screen prompts you to stop.</li>
                    <li>Speak each answer aloud (e.g. "One thousand ninety-six") and press the "Submit" button to check your answer.</li>
                    <li>If your answer is incorrect, the screen will inform you and prompt you to restart from 1,009.</li>
                    <li>Try to be as accurate and fast as possible while completing the task. Answers might take a few seconds to process.</li>
                    <li>Press the Start Test button to begin.</li>
                </ul></div><br>
                
                <button id="startTestButton1" style="display:block;">Start Test</button><br>
                <div>
                    <p id="loadingMessage1" style="display:none;">Test loading...</p>
                    <button id="submitAnswerButton1" disabled>Submit Answer</button><br><br>
                    <p id="result1"></p>
                    <p id="status1"></p>
                </div><br>
                <button class="taskComplete" onclick="completeTask('test_1')">Task Complete</button><br>
            </div><br>
            
            <button class="toggle nextButton" style="display:none;">Password</button>
            <div class="innerModule nextDiv" style="display:none;">
                <p>Thank you for filling out the pre-test information. Please let the experimenter know you have completed this section.</p>
                <form action="/submit_pwd" method="POST" id="experimenterPwd2" autocomplete="off">
                    <label for="password">Password:</label>
                    <input type="password" name="password" id="password"><br><br>
                    <button type="submit">Submit Password</button>
                </form>
                <div id="pwdErrorNotification2" style="display:none; color: red;">Incorrect Password.</div><br>
            </div><br>

            <!-- <button class="toggle nextButton" style="display:none;">Screen / VR Task 1</button>
            <div class="innerModule nextDiv" style="display:none;">
                <p>The test supervisor will now assist you with the VR headset.</p> 
                <button class="taskComplete">Task Complete</button>
            </div><br> -->
            
            <button class="toggle nextButton" style="display:none;">IAT Task 1</button>
            <div class="innerModule nextDiv" style="display:none;">
                <ul>
                    <li>The test supervisor will now assist you with the first IAT.</li>
                    <li>Complete the tasks as directed.</li>
                    <li>Press "Task Complete" when you have finished the task.</li>
                </ul>
                <button class="taskComplete" onclick="completeTask('iat_1')">Task Complete</button>
            </div><br>

            <!-- <button class="toggle nextButton" style="display:none;">PRS Survey 1</button>
            <div class="innerModule nextDiv" style="display:none;">
                <ul>
                    <li>The test supervisor will now assist you with the next section of the test.</li>
                    <li>Please press "Task Complete" when you return</li>
                </ul>
                <button class="taskComplete">Task Complete</button>
            </div><br>   -->

            <button class="toggle nextButton" style="display:none;">Break 1</button>
            <div class="innerModule nextDiv" id="break1Div" style="display:none">
                <p>Please watch the following video for 3 minutes.</p>
                <video id="video1" width="640" height="360" controls>
                    <source src="{{ url_for('video', filename='Video1.mp4') }}" type="video/mp4">
                </video><br>
                <p id="restMessage1"></p>
                <button class="taskComplete" onclick="completeTask('break_1')">Break Complete</button>
            </div><br>
            
            <button class="toggle nextButton" style="display:none;">Test 2</button>
            <div class="innerModule nextDiv" style="display:none;">
                <p>Instructions</p>
                <div><ul>
                    <li>Start with the number 1,059. For your first answer, subtract 13 from 1,059. Continue subtracting 13 from each new result until the screen prompts you to stop.</li>
                    <li>Speak each answer aloud (e.g. "One thousand ninety-six") and press the "Submit" button to check your answer.</li>
                    <li>If your answer is incorrect, the screen will inform you and prompt you to restart from 1,059.</li>
                    <li>Try to be as accurate and fast as possible while completing the task. Answers might take a few seconds to process.</li>
                    <li>Press the Start Test button to begin.</li>
                </ul></div><br>
                
                <button id="startTestButton2" style="display:block;">Start Test</button><br>
                <div>
                    <p id="loadingMessage2" style="display:none;">Test loading...</p>
                    <button id="submitAnswerButton2" disabled>Submit Answer</button><br><br>
                    <p id="result2"></p>
                    <p id="status2"></p>
                </div><br>
                <button class="taskComplete" onclick="completeTask('test_2')">Task Complete</button><br>
            </div><br>

            <button class="toggle nextButton" style="display:none;">Password</button>
            <div class="innerModule nextDiv" style="display:none;">
                <p>Thank you for filling out the pre-test information. Please let the experimenter know you have completed this section.</p>
                <form action="/submit_pwd" method="POST" id="experimenterPwd3" autocomplete="off">
                    <label for="password">Password:</label>
                    <input type="password" name="password" id="password"><br><br>
                    <button type="submit">Submit Password</button>
                </form>
                <div id="pwdErrorNotification3" style="display:none; color: red;">Incorrect Password.</div><br>
            </div><br>

            <button class="toggle nextButton" style="display:none;">IAT Task 2</button>
            <div class="innerModule nextDiv" style="display:none;">
                <ul>
                    <li>The test supervisor will now assist you with the second IAT.</li>
                    <li>Complete the tasks as directed.</li>
                    <li>Press "Task Complete" when you have finished the task.</li>
                </ul>
                <button class="taskComplete" onclick="completeTask('iat_2')">Task Complete</button>
            </div><br>

            <button class="toggle nextButton" style="display:none">Break 2</button>
            <div class="innerModule nextDiv" id="break2Div" style="display:none">
                <p>Please watch the following video for 3 minutes</p>
                <video id="video2" width="640" height="360" controls>
                    <source src="{{ url_for('video', filename='Video2.mp4') }}" type="video/mp4">
                </video><br>
                <p id="restMessage2"></p>
                <button class="taskComplete" onclick="completeTask('break_2')">Break Complete</button>
            </div>
        </div>
    </div><br>
    <button class="toggle nextButton" style="display:none;">Post Test</button>
    <div class="nextDiv" style="display:none;">
        <h2>Post Test</h2>
        <p>Please fill out the exit survey.</p>
        <div class="testModule" style="display:block;">
            <button class="toggle">Exit Survey</button>
            <div class="innerModule" id="exitSurveyDiv" style="display:none;"></div><br><br>
            <button class="taskComplete" id="postTestComplete" onclick="completeTask('exit_survey')">Task Complete</button><br>
            <p id="completeMessage" style="display:none;">All tasks are complete. Please wait for further instructions.</p>
        </div>
    </div>
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
    <script>
        const serComplete = document.getElementById('serComplete');
        const mainTasksDiv = document.getElementById('mainTasksDiv');
        const survey1Button = document.getElementById('survey1Button');
        const survey1Div = document.getElementById('survey1Div');
        const pwdErrorNotification1 = document.getElementById('pwdErrorNotification1');
        const experimenterPwd1 = document.getElementById('experimenterPwd1');
        const pwdErrorNotification2 = document.getElementById('pwdErrorNotification2');
        const experimenterPwd2 = document.getElementById('experimenterPwd2');
        const pwdErrorNotification3 = document.getElementById('pwdErrorNotification3');
        const experimenterPwd3 = document.getElementById('experimenterPwd3');
        const nameForm = document.getElementById('nameForm')
        const submitButton = document.getElementById('submitButton');
        const notification1 = document.getElementById('notification1');
        const errorNotification1 = document.getElementById('errorNotification1');
        const surveyStatus = document.getElementById('surveyStatus');
        const pss4Button = document.getElementById('pss4Button');
        const testAudio = document.getElementById('testAudio');
        const audioStatusMessage = document.getElementById('audioStatusMessage');
        const beginSERButton = document.getElementById('beginSERButton');
        // const status = document.getElementById('status');
        const questionContainer = document.getElementById('questionContainer');
        const submitAnswer = document.getElementById('submitAnswer');
        const completeMessage = document.getElementById('completeMessage');
        const exitSurveyDiv = document.getElementById('exitSurveyDiv');
        const demographicsDiv = document.getElementById('demographicsDiv');

        let pss4;
        let exitSurvey;
        let demographics;
        let breakWin;
        let breakButtons = document.getElementsByClassName('breakButton');
        let testNumber; // NOTE: testNumber is set with test_manager.current_test_index which starts at 0.
        let startTime;
        let elapsedTime = 0;
        let initialTime = 300;  // 300 = 5 minutes
        let timeLeft = initialTime;
        let timerInterval;
        let eventMarker;
        let testStarted = false;
        let testEnded = false;
        let isProcessing = false;

        const pss4Div = document.getElementById('pss4Div');
        const startTestButton1 = document.getElementById('startTestButton1');
        const startTestButton2 = document.getElementById('startTestButton2');
        const submitAnswerButton1 = document.getElementById('submitAnswerButton1');
        const submitAnswerButton2 = document.getElementById('submitAnswerButton2');
        const loadingMessage1 = document.getElementById('loadingMessage1');
        const loadingMessage2 = document.getElementById('loadingMessage2');
        const QAStatusContainer = document.getElementById('QAStatus');
        const result1 = document.getElementById('result1');
        const result2 = document.getElementById('result2');
        const testStatusContainer1 = document.getElementById('status1');
        const testStatusContainer2 = document.getElementById('status2');

        // Start Test
        startTestButton1.addEventListener('click', function() {
            eventMarker = 'stressor_test_1';
            startTestButton1.disabled = true;
            submitAnswerButton1.disabled = true;
            loadingMessage1.style.display = 'block';
            testNumber = 1;
            testEnded = false;
            setCurrentTest(testNumber - 1);
            startTest();
        });
        startTestButton2.addEventListener('click', function() {
            eventMarker = 'stressor_test_2';
            startTestButton2.disabled = true;
            submitAnswerButton2.disabled = true;
            loadingMessage2.style.display = 'block';
            testNumber = 2;
            testEnded = false;
            setCurrentTest(testNumber - 1);
            startTest();
        }); 
 
        submitAnswerButton1.addEventListener('click', processAnswer);
        submitAnswerButton2.addEventListener('click', processAnswer);

        function setCurrentTest(testNum){
            fetch('/set_current_test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ test_number: testNum })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(data.message);
                console.log("Event Marker: ", eventMarker);
                if(testNum == 0){
                    loadingMessage1.style.display = 'none';
                } else {
                    loadingMessage2.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function startTest(){
            if (eventMarker === undefined) {
                alert('Failed to start test. The event marker is not set.');
                return;
            }
            if (testStarted) {
                alert("Test already started. Please refresh the page to start again.");
                return;
            } else {
                setEventMarker(eventMarker);
                setCondition('None');
                if (testNumber == 1){
                    submitAnswerButton1.disabled = true;
                    loadingMessage1.style.display = 'block';
                    testStatusContainer1.innerText = 'Please wait...';
                } else {
                    submitAnswerButton2.disabled = true;
                    loadingMessage2.style.display = 'block';
                    testStatusContainer2.innerText = 'Please wait...';
                }
                
                fetch('/get_first_question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                    if (testNumber == 1){
                        submitAnswerButton1.disabled = false;
                        loadingMessage1.style.display = 'none';
                        startTestButton1.disabled = true;
                        testStatusContainer1.innerText = 'Recording... Speak your answer and submit when ready.';
                    } else {
                        submitAnswerButton2.disabled = false;
                        loadingMessage2.style.display = 'none';
                        startTestButton2.disabled = true;
                        testStatusContainer2.innerText = 'Recording... Speak your answer and submit when ready.';
                    }
                    startClock();  
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to start test.');
                });
                testStarted = true;
            }
        }

        function startClock() { 
            if(!timerInterval) {
                timerInterval = setInterval(updateClock, 1000);
            }
        }

        function stopClock() {
            clearInterval(timerInterval); 
            timerInterval = null;
        }
                
        function resetClock(){
            stopClock();
            timeLeft = initialTime;
        }

        function updateClock() {
            timeLeft--;
            if(timeLeft < 0) {
                clearInterval(timerInterval);
                endTest();
            }
        }

        function endTest() {
            stopClock();
            testEnded = true;
            testStarted = false;
            if (testNumber == 1){
                submitAnswerButton1.disabled = true;
                submitAnswerButton1.style.display = 'none';
                startTestButton1.style.display = 'none';
                startTestButton1.disabled = true;
                result1.style.display = 'none';
            } else {
                submitAnswerButton2.disabled = true;
                submitAnswerButton2.style.display = 'none';
                startTestButton2.style.display = 'none';
                startTestButton2.disabled = true;
                result2.style.display = 'none';
            }

            // This will simply return if isProcessing is true.
            processAnswer(testEnded);
            setEventMarker('subject_idle');
            if (testNumber === 1){
                testStatusContainer1.innerText = 'Time is up! Please let the experimenter know that you have completed this section.';
                
            } else if (testNumber === 2){
                testStatusContainer2.innerText = 'Time is up! Please let the experimenter know that you have completed this section.';
            }
            resetClock();
        }

        function processAnswer(){
            if(isProcessing) {
                return; // If function is busy, gtfo.
            }

            isProcessing = true;
            if (testNumber == 1) {
                testStatusContainer1.innerText = "Analyzing Answer...";
                submitAnswerButton1.disabled = true;
            } else {
                testStatusContainer2.innerText = "Analyzing Answer...";
                submitAnswerButton2.disabled = true;
            }

            fetch('/process_answer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ test_status: testEnded })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'complete' || testEnded) {
                    console.log(data);
                    // This block handles the eventuality that all questions have been answered
                    // It also covers eventuality that function is in-progress when clock ends.
                    if (data.status === 'complete') {
                        if (testNumber == 1){
                            testStatusContainer1.innerText = "Test complete. Please let the experimenter know that you have completed this section.";
                            submitAnswerButton1.style.display = 'none';
                        } else {
                            testStatusContainer2.innerText = "Test complete. Please let the experimenter know that you have completed this section.";
                            submitAnswerButton2.style.display = 'none';
                        }
                        isProcessing = false;
                    } 

                    if (testNumber == 1){
                        testStatusContainer1.innerText = "Test complete. Please let the experimenter know that you have completed this section.";
                        submitAnswerButton1.style.display = 'none';
                        result1.style.display = "none";
                    } else {
                        testStatusContainer2.innerText = "Test complete. Please let the experimenter know that you have completed this section.";
                        submitAnswerButton2.style.display = 'none';
                        result2.style.display = "none";
                    }
                    
                    testStarted = false;
                    stopClock();
                    eventMarker = 'subject_idle';
                    setEventMarker(eventMarker);
                    isProcessing = false;

                } else if (data.result === 'correct') {
                    if (testNumber == 1){
                        result1.innerText = "Correct.";
                        submitAnswerButton1.disabled = false;
                        testStatusContainer1.innerText = "Recording... Speak your answer and submit when ready.";
                    } else {
                        result2.innerText = "Correct.";
                        submitAnswerButton2.disabled = false;
                        testStatusContainer2.innerText = "Recording... Speak your answer and submit when ready.";
                    }
                    isProcessing = false;

                } else if (data.result === 'transciption_error'){
                    if (testNumber == 1){
                        result1.innerText = "Sorry, I couldn't understand you.";
                        testStatusContainer1.innerText = "Recording... Speak your answer and submit when ready.";
                        submitAnswerButton1.disabled = false;
                    } else {
                        result2.innerText = "Sorry, I couldn't understand you.";
                        testStatusContainer2.innerText = "Recording... Speak your answer and submit when ready.";
                        submitAnswerButton2.disabled = false;
                    }
                    isProcessing = false;
                }
                else if (data.result === 'incorrect') {
                    const restartNumber = testNumber === 1 ? "1,009" : "1,059";
                    if (testNumber == 1){
                        result1.innerText = `Incorrect. Please start again from ${restartNumber}.`;
                        testStatusContainer1.innerText = "Recording... Speak your answer and submit when ready.";
                        submitAnswerButton1.disabled = false;
                    } else {
                        result2.innerText = `Incorrect. Please start again from ${restartNumber}.`;
                        testStatusContainer2.innerText = "Recording... Speak your answer and submit when ready.";
                        submitAnswerButton2.disabled = false;
                    }
                    isProcessing = false;
                } 
                else if (data.result === 'error') {
                    if (testNumber == 1){
                        testStatusContainer1.innerText = "Sorry, I could not understand the response.";
                        submitAnswerButton1.disabled = false;
                    }
                    isProcessing = false;
                } 
            })
            .catch(error => {
                console.error('Error:', error);
                if (testNumber == 1){
                    testStatusContainer1.innerText = "Something went wrong. Please repeat your answer.";
                    submitAnswerButton1.disabled = false;
                } else {
                    testStatusContainer2.innerText = "Something went wrong. Please repeat your answer.";
                    submitAnswerButton2.disabled = false;
                }
                isProcessing = false;
            });
            
        }

        document.addEventListener('DOMContentLoaded', function(){
            for (let i = 0; i < breakButtons.length; i++) {
                breakButtons[i].addEventListener('click', function() {
                    breakWin = window.open('/break_page', '_blank', 'width=800, height=600');
                });
            }

            document.getElementById('email').addEventListener('input', checkEmailsMatch);
            document.getElementById('emailReenter').addEventListener('input', checkEmailsMatch);

            function checkEmailsMatch() {
                var email = document.getElementById('email').value;
                var emailReenter = document.getElementById('emailReenter').value;

                if (email !== emailReenter) {
                    document.getElementById('noMatch').style.display = 'block';  // Show error message
                } else {
                    document.getElementById('noMatch').style.display = 'none';  // Hide error message
                }
            }

            serComplete.addEventListener('click', function() {
                serComplete.disabled = true;
                mainTasksDiv.style.display = 'block';
            });
        });
        
        // Resets emotion baseline question index to 0 when page is loaded
        window.onload = function(){
            fetch("/reset_ser_question_index", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => console.log(data.status))
            .catch(error => console.error('Error:', error));
        }

        document.addEventListener('DOMContentLoaded', function() { 
            postTestComplete.addEventListener('click', function(){
                completeMessage.style.display = 'block';
            });
        });
        
        document.querySelectorAll('.taskComplete').forEach(button => {
            button.addEventListener('click', function() {
                let nextButton = document.querySelector('.nextButton:not([style*="display: block"])');
                let nextDiv = document.querySelector('.nextDiv:not([style*="display: block"])');

                if (nextButton) nextButton.style.display = 'block';
                if (nextDiv) nextDiv.style.display = 'block';
                button.disabled = true; // Prevents multiple clicks
            });
        });

        function submitPassword(expPwd, statusElement){
            const formData = new FormData(expPwd);
            fetch('/submit_pwd', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams(formData).toString()
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === 'Incorrect password.') {
                    statusElement.style.display = 'block';
                } else {
                    statusElement.style.display = 'none';
                    let nextButton = document.querySelector('.nextButton:not([style*="display: block"])');
                    let nextDiv = document.querySelector('.nextDiv:not([style*="display: block"])');

                    if (nextButton) nextButton.style.display = 'block';
                    if (nextDiv) nextDiv.style.display = 'block';
                }
            })
            .catch((error) => {
                statusElement.style.display = 'block';
                console.error('Error:', error);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            experimenterPwd1.addEventListener('submit', function(event){
                event.preventDefault();
                submitPassword(experimenterPwd1, pwdErrorNotification1);
            });
            
            experimenterPwd2.addEventListener('submit', function(event){
                event.preventDefault();
                submitPassword(experimenterPwd2, pwdErrorNotification2);
            });

            experimenterPwd3.addEventListener('submit', function(event){
                event.preventDefault();
                submitPassword(experimenterPwd3, pwdErrorNotification3);
            });

            nameForm.addEventListener('submit', function(event){
                event.preventDefault();
                const formData = new FormData(nameForm);
                fetch('/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams(formData).toString()
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message === 'Experiment and trial names must be set.' || data.message === "Invalid email address."){
                        notification1.style.display = "none";
                        errorNotification1.style.display = "block";
                        errorNotification1.innerHTML = data.message;
                        alert(data.message);
                    } else {
                        let deviceSetupDiv = document.getElementById('deviceSetupDiv');
                        deviceSetupDiv.style.display = 'block';
                        
                        survey1Button.style.display = 'block';
                        survey1Div.style.display = 'block';
                        notification1.style.display = 'block';
                        errorNotification1.style.display = 'none';

                        pss4 = data.pss4;
                        demographics = data.demographics;
                        exitSurvey = data.exit_survey;
                        pss4Div.innerHTML = `<iframe src="${pss4}" width="80%" height="600px" frameborder="0">Loading survey....</iframe>`;
                        pss4Div.style.display='block';
                        exitSurveyDiv.innerHTML = `<iframe src="${exitSurvey}" width="80%" height="600px" frameborder="0">Loading survey....</iframe>`;
                        exitSurveyDiv.style.display = 'block';
                        demographicsDiv.innerHTML = `<iframe src="${demographics}" width="80%" height="600px" frameborder="0">Loading survey....</iframe>`;
                        completeTask('subject_info');
                    }
                })
                .catch((error) => {
                    notification1.style.display = 'none';
                    errorNotification1.style.display = 'block';
                    console.error('Error:', error);
                });
            })
        });

        beginSERButton.addEventListener('click', function() {
            beginSERButton.disabled = true;
            questionContainer.style.display = 'block';
            // status.style.display = 'block';
            submitAnswer.style.display = 'block';
            submitAnswer.disabled = true; 
            
            // status.innerText = "Please wait before responding...";
            setEventMarker('ser_baseline');
            setCondition('None');
            startRecording()
                .then(() => {
                    submitAnswer.disabled = false;
                    // status.innerText = "Recording... Please speak clearly. Press 'Submit Answer' when finished.";
                    fetchNextQuestion();  
                })
                .catch(error => {
                    console.error('Error starting audio stream:', error);
                    alert('Error starting audio stream: ' + error);
                });
        });

        submitAnswer.addEventListener('click', function() {
            submitAnswer.disabled = true;
            // status.innerText = "Processing your answer...";
            
            fetch("/process_ser_answer", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'error') {
                    // status.innerText = data.message;
                } else {
                    // status.innerText = data.status;
                    // status.innerText = "Recording... Please speak clearly. Press 'Submit Answer' when finished.";
                    console.log(data.message);
                    return startRecording(); 
                }
            })
            .then(() => {
                submitAnswer.disabled = false;
                // status.style.display = 'none';;
                fetchNextQuestion(); 
            })
            .catch(error => {
                console.error('Error:', error);
                // status.innerText = "Error occurred while processing the answer.";
            });
        });

        function fetchNextQuestion() {
            fetch('/get_ser_question', { method: 'GET' })
                .then(response => response.json())
                .then(data => {
                    if (data.message === 'SER task completed.') {
                        setEventMarker('subject_idle');
                        submitAnswer.disabled = true;
                        submitAnswer.style.display = 'none';
                        // status.innerText = data.message;
                        questionContainer.innerText = "No more questions. Please click “Task Complete” to proceed to the next step.."
                    } else {
                        questionContainer.innerText = data.question;
                        console.log(data.question);
                    }
                })
                .catch(error => {
                    console.error('Error getting SER question:', error);
                    // status.innerText = "Error occurred while getting the SER question.";
                });
        }

        testAudio.addEventListener('click', async function() {
            if (testAudio.innerText === 'Record') {
                audioStatusMessage.innerText = "Please wait...";
                startRecording()
                .then(() => {
                    playBeep();
                })
                .then(() => {
                    audioStatusMessage.innerText = "Recording... Please say 'She sells seashells by the sea shore'. Press 'Stop' when finished.";
                    testAudio.innerText = 'Stop';      
                })
            }
            else if (testAudio.innerText === 'Stop') {
                try {
                    audioStatusMessage.innerText = "Processing response...";
                    const response = await fetch('/test_audio', { method: 'POST' });
                    const data = await response.json();
                    audioStatusMessage.innerText = `I got: ${data.result}`;
                } catch (error) {
                    console.error('Error:', error);
                    audioStatusMessage.innerText = "Error occurred during recording or transcription.";
                } finally {
                    testAudio.innerText = 'Record';
                    audioTestComplete = true;
                }
            }
        });

        var restTimeMillis = restTime * 60 * 1000;

        document.addEventListener("DOMContentLoaded", function(){

            var video1 = document.getElementById("video1");
            var video2 = document.getElementById("video2");
            var timeout1, timeout2;
            setCondition('None');
            
            function stopVideo(video, messageId, timeoutVar) {
                clearTimeout(timeoutVar); 
                return setTimeout(function() {
                    video.pause();
                    setEventMarker('subject_idle');
                    document.getElementById(messageId).innerHTML = "Your break has ended. Click 'Break Complete' to continue.";
                }, restTimeMillis);
            }

            video1.addEventListener("play", function() {
                setEventMarker('break_1');
                timeout1 = stopVideo(video1, "restMessage1", timeout1);
            });

            video2.addEventListener("play", function() {
                setEventMarker('break_2');
                timeout2 = stopVideo(video2, "restMessage2", timeout2);
            });

            document.getElementById("break1").addEventListener("click", function() {
                toggleVis("break1Div");
            });

            document.getElementById("break2").addEventListener("click", function() {
                toggleVis("break2Div");
            }); 
        });
    </script>
</body>
</html>