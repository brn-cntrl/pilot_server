<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subject Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <h1>Subject Dashboard</h1>
    <p>Please fill out each section in order. When each task is complete, a new one will appear until the experiment is completed.</p>
    <div id="pretestDiv">
        <h2>Pretest</h2>
        <!-- <p>The following is a set of pretest procedures including surveys and baseline data collection. Please complete each as instructed by the test supervisor.</p> -->
        <button class="toggle">Surveys</button><br>
        <div class="testModule" style="display:block;">
            <h2>Participant Information</h2>
            <ul>
                <li>Before performing the tasks, please fill out the following information form.</li>
                <li>Names will be obfuscated to ensure the privacy of subject data</li>
            </ul>

            <button class="toggle">Participant Information</button><br>
            <div class="innerModule" style="display:block;">
                <form action="/submit" method="POST" id="nameForm" autocomplete="off">
                    <label for="first_name">First Name:</label>
                    <input type="text" id="first_name" name="first_name" required><br><br>
                    <label for="last_name">Last Name:</label>
                    <input type="text" id="last_name" name="last_name" required><br><br>
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required><br><br>
                    <label for="emailReenter">Re-enter Email:</label>
                    <input type="email" id="emailReenter" name="emailReenter" required><br><br>
                    <span id="noMatch" style="color: red; display: none;">Emails do not match.</span><br>
                    <!-- <p>Please fill out the following information. If not applicable, please write "N/A" in each field:</p> -->
                    <label for="PID">PID:<span class="required">*</span></label>
                    <input type="text" id="PID" name="PID"><br><br>
                    <label for="class">Class you will assigning SONA credit to:<span class="required">*</span></label>
                    <input type="text" id="class" name="class"><br><br>
                    <button type="submit" id="submitButton">Submit Information</button>
                </form><br>
                <div id="notification1" style="display:none; color: green;">Form submitted successfully!</div><br>
                <div id="errorNotification1" style="display:none; color: red;">Error submitting form.</div>
                <div id="deviceSetupDiv" style="display:none;">The experimenter will now help you with the devices needed to collect data for the session.</div>
            </div><br>

        <button class="toggle" id="survey1Button" style="display:none;">Survey 1</button>
        <div class="innerModule" id="survey1Div" style="display:none;">
            <p>Please fill out this form.</p>
            <div id="demographicsDiv" style="display:block;"></div><br>
            <button class="taskComplete" onclick="completeTask('survey_1')">Task Complete</button>
        </div><br>

        <button class="toggle nextButton" style="display:none;">Survey 2</button>
        <div class="innerModule nextDiv" style="display:none;">
            <p>Please fill out this form.</p>
            <div id="pss10Div" style="display:none;"></div><br>
            <button class="taskComplete" onclick="completeTask('survey_2')">Task Complete</button>
        </div><br>

        <button class="toggle nextButton" style="display:none;">Password</button>
        <div class="innerModule nextDiv" style="display:none;">
            <p>Thank you for filling out the pre-test information. Please let the experimenter know you have completed this section.</p>
            <form action="/submit_pwd" method="POST" id="experimenterPwd1" autocomplete="off">
                <label for="password">Password:</label>
                <input type="password" name="password" id="password"><br><br>
                <button type="submit">Submit Password</button>
            </form>
            <div id="pwdErrorNotification1" style="display:none; color: red;">Incorrect Password.</div><br>
        </div><br>
        
        <button class="toggle nextButton" style="display:none;">Test Transcription</button>
        <div class="innerModule nextDiv" style="display:none;">
            <ul>
                <li>Press "Record" to test your microphone</li>
                <li>After you press "Record", please read out loud the statement that appears below.</li>
            </ul><br>
            <p id="audioStatusMessage"></p>
            <button id="testAudio">Record</button><br><br>
            <button class="taskComplete" onclick="completeTask('test_transcription')">Task Complete</button>
        </div><br>

        <button class="toggle nextButton" style="display:none;">Mood Q&A</button>
        <div class="innerModule nextDiv" style="display:none;">
            <ul>
                <li>Press "Begin" to start recording</li>
                <li>Speak your answer to each question aloud</li>
                <li>Press "Submit" to register your answer and receive the next question</li>
            </ul> <br>
            <button id="beginSERButton">Begin</button>
            <p id="QAStatus" style="display:none;" disabled></p>
            <p id="questionContainer" style="display:none;" disabled></p>
            <button id="submitAnswer" style="display:none;" disabled>Submit Answer</button><br><br>
            <button id="serComplete" onclick="completeTask('ser_baseline')">Task Complete</button>
        </div><br>
    </div><br>

    <div id="mainTasksDiv" style="display:none;">
        <div class="testModule" style="display:block;">
            <p>After completing a task, please wait for instructions before advancing to the next task.</p>
            <button class="toggle">Practice Test</button>
            <div class="innerModule test-container" id="test-container-1" style="display:none;">
                <p>Instructions</p>
                <div><ul>
                    <li>Start with the number 20. For your first answer, subtract 5 from 20. Continue subtracting 5 from each new result until the screen prompts you to stop.</li>
                    <li>Speak each answer aloud using single digit responses for best result (e.g. "One, Nine, Six" for 196) and press the "Submit" button to check your answer.</li>
                    <li>You will have 10 seconds to speak your answer.</li>
                    <li>You will then be asked to confirm the transcription.</li>
                    <li>If your answer is incorrect, the screen will inform you and prompt you to restart from 20.</li>
                    <li>Try to be as accurate and fast as possible while completing the task. Answers might take a few seconds to process.</li>
                    <li>Press the Start Test button to begin.</li>
                </ul></div><br>
                
                <button id="startTestButton0" style="display:block;">Start Test</button><br>
                <div>
                    <p id="loadingMessage0" style="display:none;">Test loading...</p>
                    <div id="clock0">Time left: 10</div><br>
                    <p id="clockStatus0" style="color: red;"></p>
                    <p id="result0"></p>
                    <p id="status0"></p>
                    <button id="yesButton0" style="display:none;" disabled>Yes</button>
                    <button id="noButton0" style="display:none;" disabled>No</button><br><br>
                    <button id="submitAnswerButton0" disabled>Submit Answer</button><br>
                </div><br>
                <button class="taskComplete" onclick="completeTask('practice_test')">Task Complete</button><br>
            </div><br>
            
            <button class="toggle nextButton" style="display:none;">Test 1</button>
            <div class="innerModule test-container nextDiv" id="test-container-1" style="display:none;">
                <p>Instructions</p>
                <div><ul>
                    <li>Start with the number 1,009. For your first answer, subtract 13 from 1,009. Continue subtracting 13 from each new result until the screen prompts you to stop.</li>
                    <li>Speak each answer aloud using single digit responses for best result (e.g. "One, Nine, Six" for 196) and press the "Submit" button to check your answer.</li>
                    <li>If your answer is incorrect, the screen will inform you and prompt you to restart from 1,009.</li>
                    <li>Try to be as accurate and fast as possible while completing the task. Answers might take a few seconds to process.</li>
                    <li>Press the Start Test button to begin.</li>
                </ul></div><br>
                
                <button id="startTestButton1" style="display:block;">Start Test</button><br>
                <div>
                    <p id="loadingMessage1" style="display:none;">Test loading...</p>
                    <div id="clock1">Time left: 10</div><br>
                    <p id="clockStatus1" style="color: red;"></p>
                    <p id="result1"></p>
                    <p id="status1"></p>
                    <button id="yesButton1" style="display:none;" disabled>Yes</button>
                    <button id="noButton1" style="display:none;" disabled>No</button><br><br>
                    <button id="submitAnswerButton1" disabled>Submit Answer</button><br>
                    
                </div><br>
                <button class="taskComplete" onclick="completeTask('test_1')">Task Complete</button><br>
            </div><br>
            
            <button class="toggle nextButton" style="display:none;">Password</button>
            <div class="innerModule nextDiv" style="display:none;">
                <p>Thank you for filling out the pre-test information. Please let the experimenter know you have completed this section.</p>
                <form action="/submit_pwd" method="POST" id="experimenterPwd2" autocomplete="off">
                    <label for="password">Password:</label>
                    <input type="password" name="password" id="password"><br><br>
                    <button type="submit">Submit Password</button>
                </form>
                <div id="pwdErrorNotification2" style="display:none; color: red;">Incorrect Password.</div><br>
            </div><br>

            <!-- <button class="toggle nextButton" style="display:none;">Screen / VR Task 1</button>
            <div class="innerModule nextDiv" style="display:none;">
                <p>The test supervisor will now assist you with the VR headset.</p> 
                <button class="taskComplete">Task Complete</button>
            </div><br> -->
            
            <button class="toggle nextButton" style="display:none;">IAT Task 1</button>
            <div class="innerModule nextDiv" style="display:none;">
                <ul>
                    <li>The test supervisor will now assist you with the first IAT.</li>
                    <li>Complete the tasks as directed.</li>
                    <li>Press "Task Complete" when you have finished the task.</li>
                </ul>
                <button class="taskComplete" onclick="completeTask('iat_1')">Task Complete</button>
            </div><br>

            <!-- <button class="toggle nextButton" style="display:none;">PRS Survey 1</button>
            <div class="innerModule nextDiv" style="display:none;">
                <ul>
                    <li>The test supervisor will now assist you with the next section of the test.</li>
                    <li>Please press "Task Complete" when you return</li>
                </ul>
                <button class="taskComplete">Task Complete</button>
            </div><br>   -->

            <button class="toggle nextButton" style="display:none;">Break 1</button>
            <div class="innerModule nextDiv" id="break1Div" style="display:none">
                <p>Please watch the following video for 5 minutes.</p>
                <video id="video1" width="640" height="360" controls>
                    <source src="{{ url_for('video', filename='Video1.mp4') }}" type="video/mp4">
                </video><br>
                <p id="restMessage1"></p>
                <button class="taskComplete" onclick="completeTask('break_1')">Break Complete</button>
            </div><br>
            
            <button class="toggle nextButton" style="display:none;">Test 2</button>
            <div class="innerModule nextDiv test-container" id="test-container-2" style="display:none;">
                <p>Instructions</p>
                <div><ul>
                    <li>Start with the number 1,059. For your first answer, subtract 13 from 1,059. Continue subtracting 13 from each new result until the screen prompts you to stop.</li>
                    <li>Speak each answer aloud using single digit responses for best result (e.g. "One, Nine, Six" for 196) and press the "Submit" button to check your answer.</li>
                    <li>If your answer is incorrect, the screen will inform you and prompt you to restart from 1,059.</li>
                    <li>Try to be as accurate and fast as possible while completing the task. Answers might take a few seconds to process.</li>
                    <li>Press the Start Test button to begin.</li>
                </ul></div><br>
                
                <button id="startTestButton2" style="display:block;">Start Test</button><br>
                <div>
                    <p id="loadingMessage2" style="display:none;">Test loading...</p>
                    <div id="clock2">Time Left: 10</div><br>
                    <p id="clockStatus2" style="color: red;"></p>
                    <p id="result2"></p>
                    <p id="status2"></p>
                    <button id="yesButton2" style="display:none;" disabled>Yes</button>
                    <button id="noButton2" style="display:none;" disabled>No</button><br><br>
                    <button id="submitAnswerButton2" disabled>Submit Answer</button><br>
                </div><br>
                <button class="taskComplete" onclick="completeTask('test_2')">Task Complete</button><br>
            </div><br>

            <button class="toggle nextButton" style="display:none;">Password</button>
            <div class="innerModule nextDiv" style="display:none;">
                <p>Thank you for filling out the pre-test information. Please let the experimenter know you have completed this section.</p>
                <form action="/submit_pwd" method="POST" id="experimenterPwd3" autocomplete="off">
                    <label for="password">Password:</label>
                    <input type="password" name="password" id="password"><br><br>
                    <button type="submit">Submit Password</button>
                </form>
                <div id="pwdErrorNotification3" style="display:none; color: red;">Incorrect Password.</div><br>
            </div><br>

            <button class="toggle nextButton" style="display:none;">IAT Task 2</button>
            <div class="innerModule nextDiv" style="display:none;">
                <ul>
                    <li>The test supervisor will now assist you with the second IAT.</li>
                    <li>Complete the tasks as directed.</li>
                    <li>Press "Task Complete" when you have finished the task.</li>
                </ul>
                <button class="taskComplete" onclick="completeTask('iat_2')">Task Complete</button>
            </div><br>

            <button class="toggle nextButton" style="display:none">Break 2</button>
            <div class="innerModule nextDiv" id="break2Div" style="display:none">
                <p>Please watch the following video for 5 minutes</p>
                <video id="video2" width="640" height="360" controls>
                    <source src="{{ url_for('video', filename='Video2.mp4') }}" type="video/mp4">
                </video><br>
                <p id="restMessage2"></p>
                <button class="taskComplete" onclick="completeTask('break_2')">Break Complete</button>
            </div>
        </div>
    </div><br>
    <button class="toggle nextButton" style="display:none;">Post Test</button>
    <div class="nextDiv" style="display:none;">
        <h2>Post Test</h2>
        <p>Please fill out the exit survey.</p>
        <div class="testModule" style="display:block;">
            <button class="toggle">Exit Survey</button>
            <div class="innerModule" id="exitSurveyDiv" style="display:none;"></div><br><br>
            <button class="taskComplete" id="postTestComplete" onclick="completeTask('exit_survey')">Task Complete</button><br>
            <p id="completeMessage" style="display:none;">All tasks are complete. Please wait for further instructions.</p>
        </div>
    </div>
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
    <script>
        const serComplete = document.getElementById('serComplete');
        const mainTasksDiv = document.getElementById('mainTasksDiv');
        const survey1Button = document.getElementById('survey1Button');
        const survey1Div = document.getElementById('survey1Div');
        const pwdErrorNotification1 = document.getElementById('pwdErrorNotification1');
        const experimenterPwd1 = document.getElementById('experimenterPwd1');
        const pwdErrorNotification2 = document.getElementById('pwdErrorNotification2');
        const experimenterPwd2 = document.getElementById('experimenterPwd2');
        const pwdErrorNotification3 = document.getElementById('pwdErrorNotification3');
        const experimenterPwd3 = document.getElementById('experimenterPwd3');
        const nameForm = document.getElementById('nameForm')
        const submitButton = document.getElementById('submitButton');
        const notification1 = document.getElementById('notification1');
        const errorNotification1 = document.getElementById('errorNotification1');
        const surveyStatus = document.getElementById('surveyStatus');
        const pss10Button = document.getElementById('pss10Button');
        const testAudio = document.getElementById('testAudio');
        const audioStatusMessage = document.getElementById('audioStatusMessage');
        const beginSERButton = document.getElementById('beginSERButton');
        const questionContainer = document.getElementById('questionContainer');
        const submitAnswer = document.getElementById('submitAnswer');
        const completeMessage = document.getElementById('completeMessage');
        const exitSurveyDiv = document.getElementById('exitSurveyDiv');
        const demographicsDiv = document.getElementById('demographicsDiv');
        const pss10Div = document.getElementById('pss10Div');
        const startTestButton0 = document.getElementById('startTestButton0');
        const startTestButton1 = document.getElementById('startTestButton1');
        const startTestButton2 = document.getElementById('startTestButton2');
        const submitAnswerButton0 = document.getElementById('submitAnswerButton0');
        const submitAnswerButton1 = document.getElementById('submitAnswerButton1');
        const submitAnswerButton2 = document.getElementById('submitAnswerButton2');
        const loadingMessage0 = document.getElementById('loadingMessage0');
        const loadingMessage1 = document.getElementById('loadingMessage1');
        const loadingMessage2 = document.getElementById('loadingMessage2');
        const QAStatusContainer = document.getElementById('QAStatus');
        const result0 = document.getElementById('result0');
        const result1 = document.getElementById('result1');
        const result2 = document.getElementById('result2');
        const testStatusContainer0 = document.getElementById('status0');
        const testStatusContainer1 = document.getElementById('status1');
        const testStatusContainer2 = document.getElementById('status2');
        const yesButton0 = document.getElementById('yesButton0');
        const yesButton1 = document.getElementById('yesButton1');
        const yesButton2 = document.getElementById('yesButton2');
        const noButton0 = document.getElementById('noButton0');
        const noButton1 = document.getElementById('noButton1');
        const noButton2 = document.getElementById('noButton2');
        const clock0 = document.getElementById('clock0');
        const clock1 = document.getElementById('clock1');
        const clock2 = document.getElementById('clock2');
        const clockStatus0 = document.getElementById('clockStatus0');
        const clockStatus1 = document.getElementById('clockStatus1');
        const clockStatus2 = document.getElementById('clockStatus2');

        const sharedAudioContext = new (window.AudioContext || window.webkitAudioContext)();

        let pss10;
        let exitSurvey;
        let demographics;
        let breakWin;
        let breakButtons = document.getElementsByClassName('breakButton');
        let testNumber; // NOTE: testNumber is set with test_manager.current_test_index which starts at 0.
        let eventMarker;
        let test1;
        let test2;
        
        function initTest0(){ // Practice Test
            test0 = new Test({
                testNumber: 0, 
                testStatusContainer: testStatusContainer0,
                startTestButton: startTestButton0,
                submitAnswerButton: submitAnswerButton0,
                resultContainer: result0,
                loadingMessage: loadingMessage0,
                yesButton: yesButton0,
                noButton: noButton0,
                clockDisplay: clock0,
                clockStatus: clockStatus0
            });
            test0.setTest(() => {
                test0.startTest();
            });
        }

        function initTest1(){
            test1 = new Test({
                testNumber: 1,
                testStatusContainer: testStatusContainer1,
                startTestButton: startTestButton1,
                submitAnswerButton: submitAnswerButton1,
                resultContainer: result1,
                loadingMessage: loadingMessage1,
                yesButton: yesButton1,
                noButton: noButton1,
                clockDisplay: clock1,
                clockStatus: clockStatus1
            });
            test1.setTest(() => {
                test1.startTest();
            });
            
        }
        function initTest2(){
            test2 = new Test({
                testNumber: 2,
                testStatusContainer: testStatusContainer2,
                startTestButton: startTestButton2,
                submitAnswerButton: submitAnswerButton2,
                resultContainer: result2,
                loadingMessage: loadingMessage2,
                yesButton: yesButton2,
                noButton: noButton2,
                clockDisplay: clock2,
                clockStatus: clockStatus2
            });
            test2.setTest(() => {
                test2.startTest();
            });
        }

        // Start Test
        startTestButton0.addEventListener('click', initTest0);
        startTestButton1.addEventListener('click', initTest1);
        startTestButton2.addEventListener('click', initTest2);

        document.addEventListener('DOMContentLoaded', function(){
            for (let i = 0; i < breakButtons.length; i++) {
                breakButtons[i].addEventListener('click', function() {
                    breakWin = window.open('/break_page', '_blank', 'width=800, height=600');
                });
            }

            document.getElementById('email').addEventListener('input', checkEmailsMatch);
            document.getElementById('emailReenter').addEventListener('input', checkEmailsMatch);

            function checkEmailsMatch() {
                var email = document.getElementById('email').value;
                var emailReenter = document.getElementById('emailReenter').value;

                if (email !== emailReenter) {
                    document.getElementById('noMatch').style.display = 'block';  // Show error message
                } else {
                    document.getElementById('noMatch').style.display = 'none';  // Hide error message
                }
            }

            serComplete.addEventListener('click', function() {
                serComplete.disabled = true;
                mainTasksDiv.style.display = 'block';
            });
        });
        
        // Resets emotion baseline question index to 0 when page is loaded
        window.onload = function(){
            fetch("/reset_ser_question_index", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => console.log(data.status))
            .catch(error => console.error('Error:', error));
        }

        document.addEventListener('DOMContentLoaded', function() { 
            postTestComplete.addEventListener('click', function(){
                completeMessage.style.display = 'block';
            });
        });
        
        document.querySelectorAll('.taskComplete').forEach(button => {
            button.addEventListener('click', function() {
                let nextButton = document.querySelector('.nextButton:not([style*="display: block"])');
                let nextDiv = document.querySelector('.nextDiv:not([style*="display: block"])');

                if (nextButton) nextButton.style.display = 'block';
                if (nextDiv) nextDiv.style.display = 'block';
                button.disabled = true; // Prevents multiple clicks
            });
        });

        function submitPassword(expPwd, statusElement){
            const formData = new FormData(expPwd);
            fetch('/submit_pwd', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams(formData).toString()
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === 'Incorrect password.') {
                    statusElement.style.display = 'block';
                } else {
                    statusElement.style.display = 'none';
                    let nextButton = document.querySelector('.nextButton:not([style*="display: block"])');
                    let nextDiv = document.querySelector('.nextDiv:not([style*="display: block"])');

                    if (nextButton) nextButton.style.display = 'block';
                    if (nextDiv) nextDiv.style.display = 'block';
                }
            })
            .catch((error) => {
                statusElement.style.display = 'block';
                console.error('Error:', error);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            experimenterPwd1.addEventListener('submit', function(event){
                event.preventDefault();
                submitPassword(experimenterPwd1, pwdErrorNotification1);
            });
            
            experimenterPwd2.addEventListener('submit', function(event){
                event.preventDefault();
                submitPassword(experimenterPwd2, pwdErrorNotification2);
            });

            experimenterPwd3.addEventListener('submit', function(event){
                event.preventDefault();
                submitPassword(experimenterPwd3, pwdErrorNotification3);
            });

            nameForm.addEventListener('submit', function(event){
                event.preventDefault();
                const formData = new FormData(nameForm);
                fetch('/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams(formData).toString()
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message === 'Experiment and trial names must be set.' || data.message === "Invalid email address."){
                        notification1.style.display = "none";
                        errorNotification1.style.display = "block";
                        errorNotification1.innerHTML = data.message;
                        alert(data.message);
                    } else {
                        let deviceSetupDiv = document.getElementById('deviceSetupDiv');
                        deviceSetupDiv.style.display = 'block';
                        
                        survey1Button.style.display = 'block';
                        survey1Div.style.display = 'block';
                        notification1.style.display = 'block';
                        errorNotification1.style.display = 'none';

                        pss10 = data.pss10;
                        demographics = data.demographics;
                        exitSurvey = data.exit_survey;
                        pss10Div.innerHTML = `<iframe src="${pss10}" width="80%" height="600px" frameborder="0">Loading survey....</iframe>`;
                        pss10Div.style.display='block';
                        exitSurveyDiv.innerHTML = `<iframe src="${exitSurvey}" width="80%" height="600px" frameborder="0">Loading survey....</iframe>`;
                        exitSurveyDiv.style.display = 'block';
                        demographicsDiv.innerHTML = `<iframe src="${demographics}" width="80%" height="600px" frameborder="0">Loading survey....</iframe>`;
                        completeTask('subject_info');
                    }
                })
                .catch((error) => {
                    notification1.style.display = 'none';
                    errorNotification1.style.display = 'block';
                    console.error('Error:', error);
                });
            })
        });

        beginSERButton.addEventListener('click', function() {
            beginSERButton.disabled = true;
            questionContainer.style.display = 'block';
            // status.style.display = 'block';
            submitAnswer.style.display = 'block';
            submitAnswer.disabled = true; 
            
            // status.innerText = "Please wait before responding...";
            setEventMarker('ser_baseline');
            setCondition('None');
            startRecording()
                .then(() => {
                    submitAnswer.disabled = false;
                    // status.innerText = "Recording... Please speak clearly. Press 'Submit Answer' when finished.";
                    fetchNextQuestion();  
                })
                .catch(error => {
                    console.error('Error starting audio stream:', error);
                    alert('Error starting audio stream: ' + error);
                });
        });

        submitAnswer.addEventListener('click', function() {
            submitAnswer.disabled = true;
            
            fetch("/process_ser_answer", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'error') {
                    // status.innerText = data.message;
                } else {
                    // status.innerText = data.status;
                    // status.innerText = "Recording... Please speak clearly. Press 'Submit Answer' when finished.";
                    console.log(data.message);
                    return startRecording(); 
                }
            })
            .then(() => {
                submitAnswer.disabled = false;
                fetchNextQuestion(); 
            })
            .catch(error => {
                console.error('Error:', error);
                status.innerText = "Error occurred while processing the answer.";
            });
        });

        function fetchNextQuestion() {
            fetch('/get_ser_question', { method: 'GET' })
                .then(response => response.json())
                .then(data => {
                    if (data.message === 'SER task completed.') {
                        setEventMarker('subject_idle');
                        submitAnswer.disabled = true;
                        submitAnswer.style.display = 'none';
                        // status.innerText = data.message;
                        questionContainer.innerText = "No more questions. Please click “Task Complete” to proceed to the next step.."
                    } else {
                        questionContainer.innerText = data.question;
                        console.log(data.question);
                    }
                })
                .catch(error => {
                    console.error('Error getting SER question:', error);
                    // status.innerText = "Error occurred while getting the SER question.";
                });
        }

        testAudio.addEventListener('click', async function() {
            if (testAudio.innerText === 'Record') {
                audioStatusMessage.innerText = "Please wait...";
                startRecording()
                    .then(() => {
                        playBeep();
                    })
                    .then(() => {
                        audioStatusMessage.innerText = "Recording... Please say 'She sells seashells by the sea shore'. Press 'Stop' when finished.";
                        testAudio.innerText = 'Stop';      
                    });
            }
            else if (testAudio.innerText === 'Stop') {
                try {
                    audioStatusMessage.innerText = "Processing response...";
                    const response = await fetch('/test_audio', { method: 'POST' });
                    const data = await response.json();
                    audioStatusMessage.innerText = `I got: ${data.result}`;
                } catch (error) {
                    console.error('Error:', error);
                    audioStatusMessage.innerText = "Error occurred during recording or transcription.";
                } finally {
                    testAudio.innerText = 'Record';
                    audioTestComplete = true;
                }
            }
        });

        var restTime = 5;
        var restTimeMillis = restTime * 60 * 1000;

        document.addEventListener("DOMContentLoaded", function(){

            var video1 = document.getElementById("video1");
            var video2 = document.getElementById("video2");
            var timeout1, timeout2;
            setCondition('None');
            
            function stopVideo(video, messageId, timeoutVar) {
                clearTimeout(timeoutVar); 
                return setTimeout(function() {
                    video.pause();
                    setEventMarker('subject_idle');
                    document.getElementById(messageId).innerHTML = "Your break has ended. Click 'Break Complete' to continue.";
                }, restTimeMillis);
            }

            video1.addEventListener("play", function() {
                setEventMarker('break_1');
                timeout1 = stopVideo(video1, "restMessage1", timeout1);
            });

            video2.addEventListener("play", function() {
                setEventMarker('break_2');
                timeout2 = stopVideo(video2, "restMessage2", timeout2);
            });
        });

        class Test {
            constructor({ testNumber, testStatusContainer, startTestButton, submitAnswerButton, resultContainer, loadingMessage, yesButton, noButton, clockDisplay, clockStatus}) {
                this.testNumber = testNumber; 
                if (this.testNumber == 0){
                    this.eventMarker = 'practice_stressor_test';
                } else {
                    this.eventMarker = `stressor_test_${this.testNumber}`;
                }
                
                //Fields for test module
                this.testStatusContainer = testStatusContainer;
                this.startTestButton = startTestButton;
                this.submitAnswerButton = submitAnswerButton;
                this.loadingMessage = loadingMessage;
                this.clockDisplay = clockDisplay;
                this.clockStatus = clockStatus;
                this.yesButton = yesButton;
                this.noButton = noButton;

                // Fields for confirmTranscription()
                this.transcription = null;
                this.confirmMessage = null;
                this.confirmStatus = null;

                // Fields for processAnswer()
                this.processedResult = null;
                this.processedStatus = null;
                this.processedMessage = null;
                this.resultContainer = resultContainer;

                this.isProcessing = false;
                this.timeUp = false;
                this.testEnded = false;
                this.testStarted = false;
                this.numToSubtract = "13";

                // Fields for timer and countdown clocks
                this.isPaused;
                this.initialTime = 300;  // 300 = 5 minutes
                this.timeLeft = this.initialTime;
                this.countdownTimeLeft = 10;
                this.timerEnded = false;
                this.currentVolumeStage = 0;

                if(this.testNumber === 0){
                    this.restartNumber = "20";
                    this.numToSubtract = "5";
                } else if (this.testNumber === 1){
                    this.restartNumber = "1,009";
                } else {
                    this.restartNumber = "1,059";
                }

                // Sounds
                this.tickingSound = new AudioPlayer(sharedAudioContext);
                this.speedMessage = new AudioPlayer(sharedAudioContext);
                this.accuracyMessage = new AudioPlayer(sharedAudioContext);
                this.correctSound = new AudioPlayer(sharedAudioContext);
                this.incorrectSound = new AudioPlayer(sharedAudioContexrt);

                this.speedMessagePlayed = false;
                this.accuracyMessagePlayed = false;

                // User Events
                this.initializeEventListeners();
            }

            async setupAudio(){    
                await this.tickingSound.load('/static/test_audio/ticking.mp3');
                await this.correctSound.load('static/test_audio/correct_v2.mp3');
                await this.incorrectSound.load('static/test_audio/incorrect_v2.mp3');

                this.tickingSound.setVolume(.2);
                this.correctSound.setVolume(.4);
                this.incorrectSound.setVolume(.4);

                if (this.testNumber == 1){
                    await this.speedMessage.load('/static/test_audio/speed_1.mp3/');
                    await this.accuracyMessage.load('/static/test_audio/accuracy_1.mp3/');
                } else if (this.testNumber == 2) {
                    await this.speedMessage.load('/static/test_audio/speed_2.mp3/');
                    await this.accuracyMessage.load('static/test_audio/accuracy_2.mp3/');
                }
                this.speedMessage.setVolume(.8);
                this.accuracyMessage.setVolume(.8);
            }
        
            setTest(callback){
                fetch('/set_current_test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ test_number: this.testNumber })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to set test number.');
                })
                .finally(() => {
                    if (callback){
                        callback();
                    }
                });
            }

            initializeEventListeners() {
                this.yesButton.addEventListener('click', this.yesButtonClickHandler.bind(this));
                this.noButton.addEventListener('click', this.noButtonClickHandler.bind(this));
                this.submitAnswerButton.addEventListener('click', this.submitAnswerButtonClickHandler.bind(this));
            }

            submitAnswerButtonClickHandler() {
                this.submitAnswerButton.disabled = true;
                this.clockStatus.innerText = '';
                this.testStatusContainer.innerText = '';
                this.pauseCountdown();

                this.confirmTranscription(false, () => {
                    this.yesButton.style.display = 'inline-block';
                    this.noButton.style.display = 'inline-block';
                    this.yesButton.disabled = false;
                    this.noButton.disabled = false;
                    this.testStatusContainer.innerText = this.transcription;
                });
            }

            yesButtonClickHandler(){
                this.processAnswer(() => {
                    this.processResult();
                });
            }
            
            noButtonClickHandler(){
                startRecording()
                .then(() => {
                    this.testStatusContainer.innerText = "Recording... Please repeat your answer and submit when ready.";
                    this.yesButton.style.display = 'none';
                    this.noButton.style.display = 'none';
                    this.submitAnswerButton.disabled = false;
                    this.resumeCountdown();
                })
                .catch(error => {
                    console.error('Error starting audio stream:', error);
                    alert('Error starting audio stream: ' + error);
                });
            }

            async startTest() {
                if(this.eventMarker === undefined){
                    alert("Failed to start test. Event Marker is not set.");
                    return;
                }

                if(this.testStarted){
                    alert("Test already started.");
                    return;
                } 
                
                setEventMarker(this.eventMarker);
                setCondition("None");

                this.submitAnswerButton.disabled = true;
                this.loadingMessage.style.display = 'block';
                this.testStatusContainer.innerText = 'Please wait...';
                
                await this.setupAudio();

                fetch('/get_first_question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                    this.submitAnswerButton.disabled = false;
                    this.loadingMessage.style.display = 'none';
                    this.startTestButton.disabled = true;
                    this.clockStatus.innerText = '';
                    this.testStatusContainer.innerText = 'Recording... Speak your answer and submit when ready.';

                    this.resumeCountdown();
                    this.startClock();  
                    this.tickingSound.play(true);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to start test.');
                });
                this.testStarted = true;
            }

            confirmTranscription(timeUp, callback){
                console.log("Confirming transcription... timeUp = ", this.timeUp);
                fetch('/confirm_transcription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ time_up: timeUp, test_status: this.testEnded })
                })
                .then(response => response.json())
                .then(data => {
                    this.confirmStatus = data.status;
                    this.confirmMessage = data.message;
                    this.transcription = data.transcription;

                    if (timeUp){
                        console.log(this.transcription);
                        console.log(this.confirmStatus);
                        console.log(this.confirmMessage);
                    } else {
                        console.log(this.transcription);
                        console.log(this.confirmStatus);
                        console.log(this.confirmMessage);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                })
                .finally(() => {
                    if(callback){
                        callback();
                    }
                });
            }

            processAnswer(callback) {
                if(this.isProcessing) {
                    return; // If function is busy, gtfo.
                }

                this.isProcessing = true;

                if(!this.submitAnswerButton.disabled){
                    this.submitAnswerButton.disabled = true;
                }
                
                if (!this.timeUp){
                    this.testStatusContainer.innerText = "Analyzing Answer...";
                } 

                fetch('/process_answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test_status: this.testEnded })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    this.processedStatus = data.status;
                    this.processedResult = data.result;
                    this.processedMessage = data.message;

                    console.log(this.processedStatus);
                    console.log(this.processedResult);
                    console.log(this.processedMessage);
                })
                .catch(error => {
                    console.error('Error:', error);
                    this.testStatusContainer.innerText = "Something went wrong. Please repeat your answer.";
                    this.submitAnswerButton.disabled = false;
                    this.clearCountdownStatus();
                    this.resetCountdown();
                    this.resumeCountdown();
                })
                .finally(() => {
                    this.isProcessing = false;
                    if (callback){
                        callback();
                    }
                });
            }

            processResult() {
                // Callback for processAnswer()
                if (this.testEnded){
                    return;
                }

                if (this.processedStatus === 'complete') {
                    // This block handles the eventuality that all questions have been answered.

                    this.stopClock();
                    this.clearCountdownStatus();
                    this.tickingSound.stop();
                    this.testStatusContainer.innerText = this.processedMessage;
                    this.resultContainer.innerText = this.processedResult;
                    this.submitAnswerButton.style.display = 'none';
                    this.submitAnswerButton.disabled = true;
                    this.startTestButton.style.display = 'none';
                    this.startTestButton.disabled = true;
                    this.testStarted = false;
                    this.eventMarker = 'subject_idle';
                    this.yesButton.style.display = 'none';
                    this.noButton.style.display = 'none';

                    setEventMarker(this.eventMarker);

                    return;
                }

                if (this.timeUp) {
                    this.resultContainer.style.color = "red";
                    this.resultContainer.innerText = `Please start again from ${this.restartNumber}.`;
                    this.testStatusContainer.innerText = "Recording... Speak your answer and submit when ready.";
                } else if (this.processedResult === 'correct') {
                    this.correctSound.play(false);
                    this.resultContainer.style.color = "green";
                    this.resultContainer.innerText = `Correct. Now subtract ${this.numToSubtract} from your answer.`;
                    this.testStatusContainer.innerText = "Recording... Speak your answer and submit when ready.";
                } else if (this.processedResult === 'incorrect') {
                    this.incorrectSound.play(false);
                    this.resultContainer.style.color = "red";
                    this.resultContainer.innerText = `Incorrect. Please start again from ${this.restartNumber}.`;
                    this.testStatusContainer.innerText = "Recording... Speak your answer and submit when ready.";
                } 

                this.resetCountdown();
                this.resumeCountdown();
                
                this.timeUp = false;
                this.timerEnded = false;
                this.yesButton.style.display = 'none';
                this.noButton.style.display = 'none';
                console.log("enabling submit button.");
                this.submitAnswerButton.disabled = false;

                this.tickingSound.setVolume(.2);
                this.currentVolumeStage = 0;

                return;
            }

            endTest() {
                this.stopClock();
                this.clearCountdownStatus();
                this.tickingSound.stop();
                this.testEnded = true;
                this.testStarted = false;
                this.submitAnswerButton.disabled = true;
                this.submitAnswerButton.style.display = 'none';
                this.startTestButton.style.display = 'none';
                this.startTestButton.disabled = true;
                this.resultContainer.style.display = 'none';

                this.processAnswer(() => {
                    this.processResult();
                });

                this.testStatusContainer.innerText = 'Time is up! Please let the experimenter know that you have completed this section.';
                // this.resetClock();
                setEventMarker('subject_idle');
            }
        
            /////////////// CLOCK ///////////////
            startClock() { 
                if(!this.timerInterval) {
                    this.timerInterval = setInterval(this.updateClock, 1000);
                }
            }

            stopClock() {
                clearInterval(this.timerInterval); 
                this.timerInterval = null;
            }
                
            resetClock(){
                this.stopClock();
                this.timeLeft = this.initialTime;
            }

            updateClock() {
                this.timeLeft--;
                if(this.timeLeft < 0){
                    clearInterval(this.timerInterval);
                    this.endTest();
                    return;
                }

                if (this.testNumber != 0){
                    if(this.timeLeft <= 180 && !this.speedMessagePlayed){ //180 seconds left
                        this.speedMessage.play(false);
                        this.speedMessagePlayed = true;
                    } else if (this.timeLeft <= 60 && !this.accuracyMessagePlayed){ // 60 seconds left
                        this.accuracyMessage.play(false);
                        this.accuracyMessagePlayed = true;
                    }
                }
                
                if(!this.isPaused){
                    this.countdownTimeLeft--;
                    if (!this.currentVolumeStage) {
                        this.currentVolumeStage = 0;
                    }
                    if (this.countdownTimeLeft <= 7 && this.countdownTimeLeft > 5){
                        if(this.currentVolumeStage !== 1){
                            this.tickingSound.setVolume(.35);
                            this.currentVolumeStage = 1;
                        }
                        
                    } else if (this.countdownTimeLeft <= 5 && this.countdownTimeLeft > 3){
                        if(this.currentVolumeStage !== 2){
                            this.tickingSound.setVolume(.65);
                            this.currentVolumeStage = 2;
                        }
                        
                    } else if (this.countdowntimeLeft <= 3 && this.countdownTimeLeft > 0){
                        if(this.currentVolumeStage !== 3){
                            this.tickingSound.setVolume(1.);
                            this.currentVolumeStage = 3;
                        }
                    }

                    if (this.countdownTimeLeft < 0) this.countdownTimeLeft = 0; // Clamp value
                    this.clockDisplay.innerText = `Time left: ${this.countdownTimeLeft}`;
                    if (this.countdownTimeLeft <= 0 && !this.timerEnded) { 
                        this.pauseCountdown();
                        console.log("disabling submit button.");
                        this.submitAnswerButton.disabled = true;
                        console.log("setting timerEnded to true.");
                        this.timerEnded = true;
                        this.timeUp = true;
                        console.log("setting Time's up and start over messages.")
                        this.clockStatus.innerText = "Time's up!";
                        this.clockStatus.style.display = 'block';
                        this.resultContainer.innerText = `Please start over at ${this.restartNumber}.`;

                        if(!this.isProcessing){
                            console.log("Calling confirmTranscription for test 1");
                            this.confirmTranscription(true, () => {
                                this.yesButton.style.display = 'none';
                                this.yesButton.disabled = true;
                                this.noButton.style.display = 'none';
                                this.noButton.disabled = true;
                                this.processAnswer(() => {
                                    this.processResult();
                                });
                            });
                        }
                    } 
                }
            }
            
            resumeCountdown() {
                console.log("resuming countdown.");
                this.isPaused = false;
            }

            resetCountdown(){
                console.log("resetting countdown.");
                this.countdownTimeLeft = 10;;
                this.timerEnded = false;
            }

            pauseCountdown() {
                this.isPaused = true;
            }

            clearCountdownStatus(){
                this.pauseCountdown();
                this.clockStatus.innerText = '';
                this.clockStatus.style.display = 'none';
            }

            startClock() {
                if(!this.timerInterval) {
                    this.timerInterval = setInterval(this.updateClock.bind(this), 1000);
                }
            }
        }

    class AudioPlayer {
        constructor(audioContext) {
            this.audioContext = audioContext;
            this.gainNode =  this.audioContext.createGain();
            this.gainNode.connect(this.audioContext.destination);

            this.buffer = null;
            this.source = null;
            this.startTime = 0;
            this.pauseTime = 0;
            this.isPlaying = false;
            this.isPaused = false;
        }

        async load(url) {
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                this.buffer = await this.audioContext.decodeAudioData(arrayBuffer);
        }

        play(loop = false) {
            if(!this.buffer) {
                console.error(`Sound ${name} not loaded.`);
                return;
            }

            if(this.isPlaying && !this.isPaused){
                this.stop();
            }

            this.source = this.audioContext.createBufferSource();
            this.source.buffer = this.buffer;
            this.source.loop = loop;
            this.source.connect(this.gainNode);

            const offset = this.isPaused ? this.pauseTime : 0;
            this.startTime = this.audioContext.currentTime - offset;
            this.source.start(0, offset);

            this.isPlaying = true;
            this.isPaused = false;
        }

        pause() {
            if(this.isPlaying && !this.isPaused){
                this.pauseTime = this.audioContext.currentTime - this.startTime;
                this.source.stop();
                this.isPaused = true;
            }
        }

        resume() {
            if(this.buffer && this.isPaused) {
                this.play(this.source.loop);
            }
        }

        stop(){
            if (this.source) {
                this.source.stop();
                this.source = null;
                this.isPlaying = false;
                this.isPaused = false;
                this.pauseTime = 0;
            }
        }

        setVolume(value) {
            this.gainNode.gain.setValueAtTime(value, this.audioContext.currentTime);
        }
    }
    </script>
</body>
</html>