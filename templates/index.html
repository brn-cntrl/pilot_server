<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilot Server Home</title>
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <h1>Experiment</h1>
    <button id="launchSubjectGUI">Launch Subject GUI</button><br><br>
    <h2>Pre-Test</h2>

    <button id="beginExperimentButton">Surveys</button><br>
    <div class="testModule" id="surveysDiv" style="display: none">
        <h2>Surveys and Participant Information</h2>
        <p>Before performing the tasks, please have the subject fill out initial forms and any necessary surveys.</p><br>
        
        <!-- Add survey list here -->

        <p><span class="required">*</span>Add any additional surveys and be sure to submit participant information before filling out surveys</p>
        <button id="addSurveyButton">Add Survey</button><br>
        <div class="innerModule" id="addSurveyDiv" style="display:none;" disabled>
            <h3>Instructions for adding surveys</h3>
            <p>1. Enter the survey name (no spaces) in the first field.</p>
            <p>2. In Google Forms, Be sure to create "Name" and "ID" fields at the top of the survey.</p>
            <p>3. Prefill each of these with the dummy values: "Sample Name", and "Sample ID"</p>
            <p>4. In "Edit" mode, select "more" in the upper right corner (three pip menu)</p>
            <p>5. Select "Get prefilled link" and copy the generated link</p>
            <p>6. Paste the link in the URL field of this form.</p>
            <p>7. Click "Submit Survey" to add the survey to the list of surveys.</p>

            <form action="/add_survey" id="addSurveyForm" method="POST">
                <label for="surveyName">Survey Name:</label>
                <input type="text" id="surveyName" name="surveyName" required><br><br>
                <label for="surveyLink">Survey URL:</label>
                <input type="text" id="surveyLink" name="URL" required><br><br>
                <button type="submit">Submit Survey</button>
            </form><br>
            <div id="notification3" style="display:none; color: green;">Survey added successfully!</div>
            <div id="errorNotification3" style="display:none; color: red;">Error adding survey.</div>
        </div><br>

        <div id="surveyList">
            <p>Current Surveys in Test Procedure</p>
            <p id="surveyStatus" style="display:block;">No surveys generated. Submit subject information to generate surveys.</p>
        </div>

    </div><br>

    <button id="biometricBaselineButton">Biometrics Baseline</button>
    <div class="testModule" id="biometricBaselineDiv" style="display:none;">
        <p>Once the subject is fitted with the Emotibit, click the button below to collect baseline data.</p>
        <button id="startBiometricBaseline">Start Collecting Baseline</button>
        <p id="biometricStatusMessage"></p>
    </div><br><br>

    <!-- <button id="stressBaselineButton">Stress Baseline</button>
    <div class="testModule" id="stressBaselineDiv" style="display:none;">
        <p>Please fill out this form.</p>
        <button id="pss4_button">Stress Baseline Survey</button><br><br>
    </div><br><br> -->

    <button id="testAudioButton">Test Audio</button>
    <div class="testModule" id="testAudioDiv" style="display:none;">
        <p>Please select your audio input or microphone.</p>
        <label for="audioDevices">Select Audio Input Device:</label><br>
        <select id="audioDevices" onchange="setDevice()"></select>
    </div> <br>

    <h2>Experimental Tasks</h2>
    <button id="tasksButton">Begin Tasks</button>
    <div class="testModule" id="tasksDiv" style="display:none;">
        <h2>Experimental Tasks</h2>
        <button id="firstStressTask">Stressor Task 1</button><br>
        <div class="innerModule" id="firstStressDiv" style="display:none;">
            <p>Instructions for the first stressor task:</p>
            <p>1. If the EmotiBit has not been fitted to subject, do so now.</p>
            <p>2. Have the subject read the instructions on their screen before starting the task.</p>
            <p>3. The subject must press "Start Test", speak each answer aloud, and press "submit" to register the answer.</p>
            <p>4. When the subject is ready, press the "Start Biometrics" button below.</p>
            <p>5. Press "Stop Biometrics" when the task is completed</p>
            <button id="startStressBiometrics1">Start Biometrics</button>
            <p id="stressStatus1" style="display:none;">Please wait...</p>
            
        </div><br>

        <button id="VRTaskButton1">VR Task 1</button>
        <div class="innerModule" id="VRTaskDiv1" style="display:none">
            <button id="VRBiometrics1">Start EmotiBit</button><br><br>
            <p id="emotibitStatus1" style="display:none;">Please wait...</p>
            <button id="VRAudio1">Start Recording</button><br><br>
            <p>Please note that when recording is stopped, post-processing may take several minutes</p>
            <p id="recordingStatus1" style="display:none;">Please wait...</p>
            <button class="compareToBaseline">Calculate Rest Time</button>
        </div><br>

        <button id="breakButton1">Take Break</button>
        <div class="innerModule" id="break1Div" style="display:none;">
            <p>Instructions for the break:</p>
            <p>1.First be sure that both biometrics and audio recording has been stopped.</p>
            <p>2. Have the subject click the "Take Break" button.</p>
            <p>3. Once they are on the break page, have them select the "Break 1" button.</p>
            <p>4. Instruct the subject to watch the video for the amount of time listed in the instructions on their screen</p>
            <button id="startBreak1">Start Break</button><br>
        </div><br>

        <button id="secondStressTask">Stressor Task 2</button>
        <div class="innerModule" id="secondStressDiv" style="display:none;">
            <p>Instructions for the second stressor task:</p>
            <p>1. If the EmotiBit has not been fitted to subject, do so now.</p>
            <p>2. Have the subject read the instructions on their screen before starting the task.</p>
            <p>3. The subject must press "Start Test", speak each answer aloud, and press "submit" to register the answer.</p>
            <p>4. When the subject is ready, press the "Start Biometrics" button below.</p>
            <p>5. Press "Stop Biometrics" when the task is completed</p>
            <button id="startStressBiometrics2">Start Biometrics</button><br>
            <p id="stressStatus2" style="display:none;">Please wait...</p>
        </div><br>

        <button id="VRTaskButton2">VR Task 2</button>
        <div class="innerModule" id="VRTaskDiv2" style="display:none">
            <button id="VRBiometrics2">Start EmotiBit</button><br><br>
            <p id="emotibitStatus2" style="display:none;">Please wait...</p>
            <button id="VRAudio2">Start Recording</button><br><br>
            <p>Please note that when recording is stopped, post-processing may take several minutes</p>
            <p id="recordingStatus2" style="display:none;">Please wait...</p>
            <button class="compareToBaseline">Calculate Rest Time</button>
        </div><br>

        <button id="breakButton2">Take a Break</button>
        <div class="innerModule" id="break2Div" style="display:none;">
            <p>Instructions for the break:</p>
            <p>1.First be sure that both biometrics and audio recording has been stopped.</p>
            <p>2. Have the subject click the "Take Break" button.</p>
            <p>3. Once they are on the break page, have them select the "Break 2" button.</p>
            <p>4. Instruct the subject to watch the video for the amount of time listed in the instructions on their screen</p>
            <p>5. Press the "Start Break" button below.</p>
            <button id="startBreak2">Start Break</button><br>
        </div><br>
    </div><br>

    <h2>Post-Test</h2>
    <button id="exitSurveyButton">Exit Survey</button><br><br>
    <button id="uploadSubjectData">Upload Experiment Data</button><br><br>

    <h2>Shutdown</h2>
    <button id="shutdownButton">Shutdown Server</button>
    <script src="/static/js/scripts.js"></script>
    <script>
        // TODO: Add disabling for task completion logic.
        document.addEventListener('DOMContentLoaded', function(){
            document.getElementById('addSurveyButton').addEventListener('click', function() {
                toggleVis('addSurveyDiv');
            });

            document.getElementById('beginExperimentButton').addEventListener('click', function() {
                toggleVis('surveysDiv');
            });

            document.getElementById('launchSubjectGUI').addEventListener('click', function() {
                window.open('/subject_gui', '_blank', 'width=1200, height=720');
            });

            document.getElementById('exitSurveyButton').addEventListener('click', function() {
                window.open('/exit_survey', '_blank');
            });

            document.getElementById('testAudioButton').addEventListener('click', function() {
                toggleVis('testAudioDiv');
            });

            // document.getElementById('participantInfoButton').addEventListener('click', function() {
            //     toggleVis('participantInfoDiv');
            // });

            document.getElementById('tasksButton').addEventListener('click', function(){
                toggleVis('tasksDiv');
            });

            document.getElementById('biometricBaselineButton').addEventListener('click', function() {
                toggleVis('biometricBaselineDiv');
            });

            document.getElementById('firstStressTask').addEventListener('click', function() {
                toggleVis('firstStressDiv');
            });

            document.getElementById('secondStressTask').addEventListener('click', function() {
                toggleVis('secondStressDiv');
            });

            document.getElementById("VRTaskButton1").addEventListener('click', function(){
                toggleVis('VRTaskDiv1');
            });
                
            document.getElementById("VRTaskButton2").addEventListener('click', function(){
                toggleVis('VRTaskDiv2');
            });

            
            document.getElementById('breakButton1').addEventListener('click', function() {
                toggleVis('break1Div');
            });

            document.getElementById('breakButton2').addEventListener('click', function() {
                toggleVis('break2Div');
            }); 
        });
        
        document.addEventListener('DOMContentLoaded', function(){
            const form = document.getElementById('addSurveyForm');
            form.addEventListener('submit', function(event){
                event.preventDefault();
                const notification3 = document.getElementById('notification3');
                const errorNotification3 = document.getElementById('errorNotification3');
                const formData = new FormData(form);
                fetch('/add_survey', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    notification3.style.display = 'block';
                    errorNotification3.style.display = 'none';
                    loadSurveys();
                })
                .catch(error => {
                    notification3.style.display = 'none';
                    errorNotification3.style.display = 'block';
                    console.error('Error:', error);
                });
            });

            baselineButton = document.getElementById("startBiometricBaseline");
            baselineButton.addEventListener("click", function() {
                if (baselineButton.innerText == "Start Collecting Baseline") {
                    pushTaskId('biometric_baseline');
                    startBaseline();
                    baselineButton.innerText = "Stop Collecting Baseline";
                } else {
                    pushTaskId('subject_idle')
                    stopBaseline();
                    baselineButton.innerText = "Start Collecting Baseline";
                }
            });

            const compareBaselineButtons = document.querySelectorAll('.compareToBaseline');
            compareBaselineButtons.forEach(button => {
                button.addEventListener('click', function() {
                    compareToBaseline();
                });
            });
        });

        document.addEventListener('DOMContentLoaded', (event) => {
            console.log('Fetching audio devices...');
            fetchAudioDevices();
            const audioDevicesDropdown = document.getElementById('audioDevices');
            audioDevicesDropdown.addEventListener('change', setDevice);

            const shutdownButton = document.getElementById('shutdownButton');
            shutdownButton.addEventListener('click', shutdownServer);
        });

        document.addEventListener('DOMContentLoaded', function(){
            let stress1Button = document.getElementById('startStressBiometrics1');
            let stress1Status = document.getElementById('stressStatus1');
            stress1Button.addEventListener('click', function() {
                if(stress1Button.innerText == 'Start Biometrics'){
                    pushTaskId('stressor_test_1')
                    fetch('/start_emotibit_stream', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);
                        stress1Button.innerText = 'Stop Biometrics';
                        stress1Status.innerText = 'Collecting Biometrics...';
                        stress1Status.style.display = 'block';
                    })
                    .catch(error => console.error('Error:', error));
                } else {
                    pushTaskId('subject_idle')
                    fetch('/push_emotibit_data', {
                        method: 'POST',
                        label: 'stress_test_1'
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);
                        stress1Button.innerText = 'Start Biometrics';
                        stress1Status.style.display = 'none';
                    })
                    .catch(error => console.error('Error:', error));
                }
            });

            let stress2Button = document.getElementById('startStressBiometrics2');
            let stress2Status = document.getElementById('stressStatus2');
            stress2Button.addEventListener('click', function() {
                if(stress2Button.innerText == 'Start Biometrics'){
                    pushTaskId('stressor_test_2');
                    fetch('/start_emotibit_stream', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);
                        stress2Button.innerText = 'Stop Biometrics';
                        stress2Status.innerText = 'Collecting Biometrics...';
                        stress2Status.style.display = 'block';
                    })
                    .catch(error => console.error('Error:', error));
                } else {
                    pushTaskId('subject_idle')
                    fetch('/push_emotibit_data', {
                        method: 'POST',
                        label: 'stress_test_2'
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);
                        stress2Button.innerText = 'Start Biometrics';
                        stress2Status.style.display = 'none';
                    })
                    .catch(error => console.error('Error:', error));
                }
            });

            let VRAudio1 = document.getElementById('VRAudio1');
            let VRAudio2 = document.getElementById('VRAudio2');

            VRAudio1.addEventListener('click', function() {
                if (VRAudio1.innerText == "Start Recording"){
                    VRAudio1.innerText = "Stop Recording";
                    VRRecording(VRAudio1, 'start');
                } else {
                    VRAudio1.innerText = "Start Recording";
                    VRRecording(button, 'stop');
                }
            });

            VRAudio2.addEventListener('click', function() {
                if (VRAudio2.innerText == "Start Recording"){
                    VRAudio2.innerText = "Stop Recording";
                    VRRecording(VRAudio1, 'start');
                } else {
                    VRAudio2.innerText = "Start Recording";
                    VRRecording(button, 'stop');
                }
            });

            let VRBiom1 = document.getElementById('VRBiometrics1');
            let VRBiom2 = document.getElementById('VRBiometrics2');

            VRBiom1.addEventListener('click', function() {
                if (VRBiom1.innerText == "Start EmotiBit"){
                    pushTaskId('VR_task_1');
                    VRBiom1.innerText = "Stop Task";
                    fetch('/start_emotibit_stream', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);
                    })
                    .catch(error => console.error('status:', error));
                } else {
                    pushTaskId('subject_idle');
                    VRBiom1.innerText = "Start EmotiBit"
                    fetch('/push_emotibit_data', {
                        method: 'POST',
                        label: 'VR_task_1'
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);
                    })
                    .catch(error => console.error('message:', error));
                }
            });

            VRBiom2.addEventListener('click', function() {
                if (VRBiom2.innerText == "Start EmotiBit"){
                    pushTaskId('VR_task_2');
                    VRBiom2.innerText = "Stop Task"
                    fetch('/start_emotibit_stream', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);
                    })
                    .catch(error => console.error('status:', error));
                } else {
                    pushTaskId('subject_idle');
                    VRBiom2.innerText = "Start EmotiBit"
                    fetch('/push_emotibit_data', {
                        method: 'POST',
                        label: 'VR_task_2'
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);
                    })
                    .catch(error => console.error('message:', error));
                }
            });

            let breakButton1 = document.getElementById('startBreak1');
            let breakButton2 = document.getElementById('startBreak2');

            breakButton1.addEventListener('click', function(){
                if(breakButton1.innerText == "Start Break"){
                    pushTaskId('break_1');
                    breakButton1.innerText = "End Break";
                } else {
                    pushTaskId('subject_idle');
                    breakButton1.innerText = "Start Break";
                }
            });

            breakButton2.addEventListener('click', function(){
                if(breakButton2.innerText == "Start Break"){
                    pushTaskId('break_2');
                    breakButton2.innerText = "End Break";
                } else {
                    pushTaskId('subject_idle');
                    breakButton1.innerText = "Start Break";
                }
            });

            function VRRecording(button, action){
                const taskID = button.id;
                console.log(`taskID: ${taskID}, action: ${action}`);  // Debugging statement
                statusId1 = document.getElementById("recordingStatus1");
                statusId2 = document.getElementById("recordingStatus2");
                if(action == 'start'){
                    startRecording();
                    let checkInterval = setInterval(() => {
                        if (checkActiveStream()) {
                            console.log("Stream is active.");
                            if (taskID == 'VRAudio1'){
                                statusId1.style.display = 'block';
                                statusId1.innerHTML = 'Recording stream active.';
                            } else if (taskID == 'VRAudio2'){
                                statusId2.style.display = 'block';
                                statusId2.innerHTML = 'Recording stream active.';
                            }
                            clearInterval(checkInterval); // Stop checking once stream is active
                        } else {
                            if(taskID == 'VRAudio1'){
                                statusId1.style.display = 'block';
                                statusId1.innerHTML = 'Recording stream is not active yet, Please wait...';
                            } else if (taskID == 'VRAudio2'){
                                statusId2.style.display = 'block';
                                statusId2.innerHTML = 'Recording stream is not active yet, Please wait...';
                            }
                        }
                    }, 2000); 

                } else if (action == 'stop'){
                    console.log(`taskID: ${taskID}, action: ${action}`);
                    if(taskID == 'taskID1'){
                        statusId1.style.display = 'block';
                        statusId1.innerHTML = 'Recording stopped. Please wait. Post-processing may take several minutes.';
                    } else if (taskID == 'taskID2'){
                        statusId2.style.display = 'block';
                        statusId2.innerHTML = 'Recording stopped. Please wait. Post-processing may take several minutes.';
                    }

                    fetch('/record_vr_task', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            task_id: taskID,
                            action: action
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Success:', data);
                        if(taskID == 'taskID1'){
                            statusId1.style.display = 'block';
                            statusId1.innerHTML = data.message;
                        } else if (taskID == 'taskID2'){
                            statusId2.style.display = 'block';
                            statusId2.innerHTML = data.message;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                }
            }

            document.getElementById('uploadSubjectData').addEventListener('click', function() {
                fetch('/upload_subject_data', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data.message);
                })
                .catch(error => console.error('Error:', error));
            });
        });

    </script>
</body>
</html>