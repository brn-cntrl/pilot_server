<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilot Server Home</title>
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <h1>Experiment</h1>
    <h2>Pre-Test</h2>

    <button id="beginExperimentButton">Surveys</button><br>
    <div class="testModule" id="surveysDiv" style="display: none">
        <h2>Surveys and Participant Information</h2>
        <p>Before performing the tasks, please fill out the following forms and surveys.</p><br>
        
        <button id="participantInfoButton">Participant Information</button><br>
        <div class="innerModule" id="participantInfoDiv" style="display:none;">
            <form action="/submit" method="POST" id="nameForm">
                <label for="name">Name:</label>
                <input type="text" id="name" name="name" required><br><br>
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required><br><br>
                <button type="submit" id="submitButton">Submit Information</button>
            </form><br>
            <div id="notification1" style="display:none; color: green;">Form submitted successfully!</div>
            <div id="errorNotification1" style="display:none; color: red;">Error submitting form.</div>
        </div><br>

        <button id="studentSurveyButton">Student Information</button><br><br>
        <div class="innerModule" id="studentDiv" style="display:none;" disabled>
            <p>Please fill out the following information if applicable:</p>
            <form action="/submit_student_data" id="studentForm" method="POST">
                <label for="PID">PID:<span class="required">*</span></label>
                <input type="text" id="PID" name="PID" required><br><br>
                <label for="class">Class you will assigning SONA credit to:<span class="required">*</span></label>
                <input type="text" id="class" name="class" required><br><br>
                <input type="submit" value="Submit">
            </form><br>
            <div id="notification2" style="display:none; color: green;">Form submitted successfully!</div>
            <div id="errorNotification2" style="display:none; color: red;">Error submitting form.</div>
        </div>
        <p><span class="required">*</span>Add any additional surveys and be sure to submit participant information before filling out surveys</p>
        <button id="addSurveyButton">Add Survey</button><br>
        <div class="innerModule" id="addSurveyDiv" style="display:none;" disabled>
            <h3>Instructions for adding surveys</h3>
            <p>1. Enter the survey name (no spaces) in the first field.</p>
            <p>2. In Google Forms, Be sure to create "Name" and "ID" fields at the top of the survey.</p>
            <p>3. Prefill each of these with the dummy values: "Sample Name", and "Sample ID"</p>
            <p>4. In "Edit" mode, select "more" in the upper right corner (three pip menu)</p>
            <p>5. Select "Get prefilled link" and copy the generated link</p>
            <p>6. Paste the link in the URL field of this form.</p>
            <p>7. Click "Submit Survey" to add the survey to the list of surveys.</p>

            <form action="/add_survey" id="addSurveyForm" method="POST">
                <label for="surveyName">Survey Name:</label>
                <input type="text" id="surveyName" name="surveyName" required><br><br>
                <label for="surveyLink">Survey URL:</label>
                <input type="text" id="surveyLink" name="URL" required><br><br>
                <button type="submit">Submit Survey</button>
            </form><br>
            <div id="notification3" style="display:none; color: green;">Survey added successfully!</div>
            <div id="errorNotification3" style="display:none; color: red;">Error adding survey.</div>
        </div><br>

        <div id="surveyList">
            <p>Current Surveys in Test Procedure</p>
            <p id="surveyStatus" style="display:block;">No surveys generated. Submit subject information to generate surveys.</p>
        </div>
        

        <!-- <button id="consentFormButton">Consent Form</button><br><br>
        <button id="demographicSurveyButton">Demographic Survey</button><br><br>
        <button id="backgroundInfoButton">Background Information</button><br><br> -->

    </div><br>

    <button id="biometricBaselineButton">Biometrics Baseline</button>
    <div class="testModule" id="biometricBaselineDiv" style="display:none;">
        <p>Once the subject is fitted with the Emotibit, click the button below to collect baseline data.</p>
        <button id="startBiometricBaseline">Start Collecting Baseline</button>
        <p id="biometricStatusMessage"></p>
    </div><br><br>

    <!-- <button id="stressBaselineButton">Stress Baseline</button>
    <div class="testModule" id="stressBaselineDiv" style="display:none;">
        <p>Please fill out this form.</p>
        <button id="pss4_button">Stress Baseline Survey</button><br><br>
    </div><br><br> -->

    <button id="testAudioButton">Test Audio</button><br>
    <div class="testModule" id="testAudioDiv" style="display:none;">
        <p>Please select your audio input or microphone.</p>
        <label for="audioDevices">Select Audio Input Device:</label><br>
        <select id="audioDevices" onchange="setDevice()"></select>
    </div> <br>

    <!-- <button id="emotionBaselineButton">Emotion Baseline</button><br>
    <div class="testModule" id="emotionBaselineDiv" style="display:none;">
        <ul></ul>
            <li>Press "Begin"</li>
            <li>Read the first question when it appears</li>
            <li>Speak your answer aloud</li>
            <li>Press "Submit" to register your answer and receive the next question</li>
        </ul> <br>
        <button id="beginSERButton">Begin</button>
        <p id="status" style="display:none;" disabled></p>
        <p id="questionContainer" style="display:none;" disabled></p>
        <button id="submitAnswer" style="display:none;" disabled>Submit Answer</button>
    </div><br> -->

    <h2>Experimental Tasks</h2>
    <button id="tasksButton">Begin Tasks</button><br>
    <div class="testModule" id="tasksDiv" style="display:none;">
        <h2>Experimental Tasks</h2>
        <button id="launchSubjectGUI">Launch Subject GUI</button><br><br>
        <button id="firstStressTask">First Stressor Task</button><br><br>
        <button id="firstVRTask">First VR Task</button><br><br>
        <button class="breakButton">Take Break</button><br><br>
        <button id="secondStressTask">Second Stressor Task</button><br><br>
        <button id="secondVRTask">Second VR Task / Control</button><br><br>
        <button class="breakButton">Take a Break</button>
    </div><br>

    <h2>Post-Test</h2>
    <button id="exitSurveyButton">Exit Survey</button><br><br>
    <button id="uploadSubjectData">Upload Experiment Data</button><br><br>

    <h2>Shutdown</h2>
    <button id="shutdownButton">Shutdown Server</button>
    <script src="/static/js/scripts.js"></script>
    <script>
        

        

        document.getElementById('addSurveyButton').addEventListener('click', function() {
            toggleVis('addSurveyDiv');
        });

        document.getElementById('beginExperimentButton').addEventListener('click', function() {
            toggleVis('surveysDiv');
        });

        document.getElementById('studentSurveyButton').addEventListener('click', function() {
            toggleVis('studentDiv');
        });

        document.addEventListener('DOMContentLoaded', function(){
            const form = document.getElementById('addSurveyForm');
            form.addEventListener('submit', function(event){
                event.preventDefault();
                const notification3 = document.getElementById('notification3');
                const errorNotification3 = document.getElementById('errorNotification3');
                const formData = new FormData(form);
                fetch('/add_survey', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    notification3.style.display = 'block';
                    errorNotification3.style.display = 'none';
                    loadSurveys();
                })
                .catch(error => {
                    notification3.style.display = 'none';
                    errorNotification3.style.display = 'block';
                    console.error('Error:', error);
                });
            });
        });

        document.getElementById('launchSubjectGUI').addEventListener('click', function() {
            window.open('/subject_gui', '_blank');
        });

        document.getElementById('exitSurveyButton').addEventListener('click', function() {
            window.open('/exit_survey', '_blank');
        });

        document.getElementById('testAudioButton').addEventListener('click', function() {
            toggleVis('testAudioDiv');
        });

        document.getElementById('participantInfoButton').addEventListener('click', function() {
            toggleVis('participantInfoDiv');
        });

        document.getElementById('tasksButton').addEventListener('click', function(){
            toggleVis('tasksDiv');
        });

        document.getElementById('biometricBaselineButton').addEventListener('click', function() {
            toggleVis('biometricBaselineDiv');
        });

        baselineButton = document.getElementById("startBiometricBaseline");
        function startBaseline() {
            fetch("/start_emotibit_stream", {
                method: "POST"
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(data.message);
                baselineButton.innerText = "Stop Collecting Baseline";
                document.getElementById('biometricStatusMessage').innerText = data.message;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('biometricStatusMessage').innerText = "Error occurred while starting biometric baseline.";
            });
        }

        function stopBaseline() {
            fetch("/get_biometric_baseline", {
                method: "POST"
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(data.message);
                baselineButton.innerText = "Start Collecting Baseline";
                document.getElementById('biometricStatusMessage').innerText = data.message;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('biometricStatusMessage').innerText = "Error occurred while stopping biometric baseline.";
            });
        }

        baselineButton.addEventListener("click", function() {
            if (baselineButton.innerText == "Start Collecting Baseline") {
                startBaseline();
            } else {
                stopBaseline();
            }
        });

        let vrWin;

        document.getElementById('firstVRTask').addEventListener('click', function() {
            vrWin = window.open('/vr_task', '_blank');
            if (vrWin) {
                vrWin.focus();
            } else {
                alert('Please allow popups');
            }
        });

        document.getElementById('secondVRTask').addEventListener('click', function() {
            vrWin = window.open('/vr_task', '_blank');
            if (vrWin) {
                vrWin.focus();
            } else {
                alert('Please allow popups');
            }
        });

        let breakWin;
        let breakButtons = document.getElementsByClassName('breakButton');
        for (let i = 0; i < breakButtons.length; i++) {
            breakButtons[i].addEventListener('click', function() {
                breakWin = window.open('/break_page', '_blank');
                if (breakWin) {
                    breakWin.focus();
                } else {
                    alert('Please allow popups for this website');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            console.log('Fetching audio devices...');
            fetchAudioDevices();
            const audioDevicesDropdown = document.getElementById('audioDevices');
            audioDevicesDropdown.addEventListener('change', setDevice);

            const shutdownButton = document.getElementById('shutdownButton');
            shutdownButton.addEventListener('click', shutdownServer);
        });

        document.getElementById('firstStressTask').addEventListener('click', function() {
            window.open('/test_page', '_blank');
        });
        
        document.getElementById('uploadSubjectData').addEventListener('click', function() {
            fetch('/upload_subject_data', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                console.log(data.message);
            })
            .catch(error => console.error('Error:', error));
        });
    </script>
</body>
</html>