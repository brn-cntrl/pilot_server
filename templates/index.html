<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experiment Dashboard</title>
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <h1>Experiment Dashboard</h1>
    <span class="buttonRow">
        <button class="stopEmotibit">Stop Emotibit</button>
        <button class="stopServer">Stop Server</button>
        <button class="stopVernier">Stop Respiratory Belt</button><br>
        <p class="emotibitStatus"></p>
        <p class="vernierStatus"></p>
    </span><br>

    <div class="testModule" id="preTestDiv">
    <button class="toggle">Experiment/Trial Information</button><br>
    <div class="innerModule" style="display:block;">
        <h3>Experiment/Trial Information</h3>
        <form id="experimentNameForm" action="/submit_experiment" method="POST" autocomplete="off">
            <label for="experiment_name">Experiment Name:</label>
            <input type="text" id="experiment_name" name="experiment_name" required><br><br>
            <label for="trial_name">Trial Name:</label>
            <input type="text" id="trial_name" name="trial_name" required><br><br>
            <button type="submit">Submit</button>
        </form><br>
        <div id="notification1" style="display:none; color: green;"></div>
        <div id="errorNotification1" style="display:none; color: red;"></div>

        <!-- <p id="postSubmitMessage" style="display:none;">Now you will put the Emotibit, mic, and respiration belt on the subject. Please read the provided script as you place the devices.</p> -->
    </div><br>

    <button class=toggle>Subject Dashboard</button><br>
    <div class="innerModule" style="display:block">
        <button id="launchSubjectGUI">Launch Subject Dashboard</button><br>
        <p id="subject_info" style="display:none; color: green;">Subject has submitted the Information Form.</p>
        <p id="survey_1" style="display:none; color: green;">Subject has submitted the Demographic Form.</p>
        <p id="survey_2" style="display:none; color: green;">Subject has submitted the PSS-10 Form.</p>
    </div><br>

    <button class="toggle">Device Setup</button><br>
    <div class="innerModule" style="display:none;">
        <h3>Device Startup</h3>
        <button id="startEmotibitButton">Start EmotiBit</button><br>
        <p class="emotibitStatus"></p>
        <button id="startVernierButton">Start Respiratory Belt</button><br>
        <p class="vernierStatus"></p>
    </div><br>

    <button class="toggle">Biometrics Baseline</button><br>
    <div class="innerModule" style="display:none;">
        <button id="startBiometricBaseline">Start Collecting Baseline</button>
        <p id="biometricStatusMessage"></p>
    </div><br>

    <button class="toggle">Test Audio</button><br>
    <div class="innerModule" style="display:none;">
        <button id="testAudioOutput">Test Audio Output</button><br><br>
        <label for="audioDevices">Select Audio Input Device:</label><br><br>
        <select id="audioDevices" onchange="setDevice()"></select><br><br>
    </div><br>

    <p id="test_transcription" style="display:none; color:green;">Subject has completed the test transcription.</p>
    <p id="ser_baseline" style="display:none; color:green;">Subject has completed the SER baseline task.</p>

    <button class="toggle">SART Task 1</button><br>
    <div class="innerModule" style="display:none;">
        <button id="sart1" class="SARTButton">Start Task</button><br>
    </div><br>
    <p id="sart_1" style="display:none; color:green;">Subject has completed the first SART task.</p>

    <p id="practice_test" style="display:none; color:green;">Subject has completed the practice stress task.</p>
    <p id="test_1" style="display:none; color:green;">Subject has completed the first stress task.</p>

    <button class="toggle">SART Task 2</button><br>
    <div class="innerModule" style="display:none;">
        <button id="sart2" class="SARTButton">Start Task</button><br><br>
    </div><br>
    <p id="sart_2" style="display:none; color:green;">Subject has completed the second SART task.</p>

    <h2>Experimental Tasks</h2>
    <button class="toggle">Begin Tasks</button><br>
    <div class="testModule" style="display:none;">
        <h3>Experimental Tasks</h3>
        <!-- Task for continuous recording -->
        <button class="toggle">Task 1 (General Recording)</button><br>
        <div class="innerModule" id='taskGenDiv1' style="display:none">
            <p><span class="required">IMPORTANT:</span> If General Recording is chosen, do NOT perform any other recording tasks while it is active.</p>
            <select onchange="updateCondition('taskGenDiv1', 'task_1')">
                <option value="no_condition" selected>Select Condition</option>
                <option value="physical_plants">Physical / Plants</option>
                <option value="physical_no_plants">Physical / No Plants</option>
                <option value="virtual_plants">Virtual / Plants</option>
                <option value="virtual_no_plants">Virtual / No Plants</option>
            </select><br><br>
            <button id="task_1_recording">Start Recording</button><br><br>
            <p id="recordingStatus1" style="display:none;">Please wait...</p>
        </div><br>

        <button class="toggle">Task 1</button><br>
        <div class="innerModule" id="taskDiv1" style="display:none">
            <select onchange="updateCondition('taskDiv1', 'task_1')">
                <option value="no_condition" selected>Select Condition</option>
                <option value="physical_plants">Physical / Plants</option>
                <option value="physical_no_plants">Physical / No Plants</option>
                <option value="virtual_plants">Virtual / Plants</option>
                <option value="virtual_no_plants">Virtual / No Plants</option>
            </select><br><br>
            <button class="openRoomObservationTask">Go to Task</button><br><br>
        </div><br>

        <button class="toggle">PRS Task 1</button><br>
        <div class="innerModule" id='prsDiv1' style="display:none">
            <select onchange="updateCondition('prsDiv1', 'prs_1')">
                <option value="no_condition" selected>Select an option</option>
                <option value="physical_plants">Physical / Plants</option>
                <option value="physical_no_plants">Physical / No Plants</option>
                <option value="virtual_plants">Virtual / Plants</option>
                <option value="virtual_no_plants">Virtual / No Plants</option>
            </select><br><br>
            <button id="startPRSTask1">Start Task</button><br>
            <!-- <p id="breakInstructions1" style="display:none;">After the PRS is complete, you will move with the subject back into the break room. They will then complete the IAT, Break 1, and Stress Task #2</p> -->
        </div><br>

        <button class="toggle">SART Task 3</button><br>
        <div class="innerModule" style="display:none;">
            <button id="sart3" class="SARTButton">Start Task</button><br><br>
        </div><br>
        <p id="sart_3" style="display:none; color:green;">Subject has completed the third SART task.</p>
        <p id="break_1" style="display:none; color:green;">Subject has completed the first break.</p>

        <button class="toggle">SART Task 4</button><br>
        <div class="innerModule" style="display:none;">
            <button id="sart4" class="SARTButton">Start Task</button><br><br>
        </div><br>
        <p id="sart_4" style="display:none; color:green;">Subject has completed the fourth SART task.</p>
        <p id="test_2" style="display:none; color:green;">Subject has completed the second stress task.</p>

        <button class="toggle">SART Task 5</button><br>
        <div class="innerModule" style="display:none;">
            <button id="sart5" class="SARTButton">Start Task</button><br><br>
        </div><br>
        <p id="sart_5" style="display:none; color:green;">Subject has completed the fifth SART task.</p>

        <button class="toggle">Task 2 (General Recording)</button><br>
        <div class="innerModule" id="taskGenDiv2" style="display:none">
            <p><span class="required">IMPORTANT:</span> If General Recording is chosen, do NOT perform any other recording tasks while it is active.</p>
            <select onchange="updateCondition('taskGenDiv2', 'task_2')">
                <option value="no_condition" selected>Select an option</option>
                <option value="physical_plants">Physical / Plants</option>
                <option value="physical_no_plants">Physical / No Plants</option>
                <option value="virtual_plants">Virtual / Plants</option>
                <option value="virtual_no_plants">Virtual / No Plants</option>
            </select><br><br>

            <button id="task_2_recording">Start Recording</button><br><br>
            <p id="recordingStatus2" style="display:none;">Please wait...</p>
        </div><br>

        <button class="toggle" id="taskButton2">Task 2</button><br>
        <div class="innerModule" id="taskDiv2" style="display:none">
            <select onchange="updateCondition('taskDiv2', 'task_2')">
                <option value="no_condition" selected>Select an option</option>
                <option value="physical_plants">Physical / Plants</option>
                <option value="physical_no_plants">Physical / No Plants</option>
                <option value="virtual_plants">Virtual / Plants</option>
                <option value="virtual_no_plants">Virtual / No Plants</option>
            </select><br><br>

            <button class="openRoomObservationTask">Go to Task</button><br><br>
        </div><br>

        <button class="toggle">PRS Task 2</button><br>
        <div class="innerModule" id="prsDiv2" style="display:none">
            <select onchange="updateCondition('prsDiv2', 'prs_2')">
                <option value="no_condition" selected>Select an option</option>
                <option value="physical_plants">Physical / Plants</option>
                <option value="physical_no_plants">Physical / No Plants</option>
                <option value="virtual_plants">Virtual / Plants</option>
                <option value="virtual_no_plants">Virtual / No Plants</option>
            </select><br><br>
            <button id="startPRSTask2">Start Task</button><br>
            <!-- <p id="breakInstructions2" style="display:none;">After the PRS is complete, you will move with the subject back into the break room. They will then complete the IAT #2 and Break 2</p> -->
        </div><br>

        <button class="toggle">SART Task 6</button><br>
        <div class="innerModule" style="display:none;">
            <button id="sart6" class="SARTButton">Start Task</button><br><br>
        </div><br>
        <p id="sart_6" style="display:none; color:green;">Subject has completed the sixth SART task.</p>

        <p id="break_2" style="display:none; color:green;">Subject has completed the second break.</p>
    </div>

    <h2>Post-Test</h2>
    <button class="toggle">Post-test Tasks</button>
    <div class="testModule" style="display:none;">
        <button class="toggle">Exit Survey</button><br>
        <div class="innerModule" style="display:none;">
            <h4>Exit Survey</h4>
            <p id="exit_survey" style="display:none; color:green;">Subject has completed the exit survey.</p>
        </div><br>
       
        <button class="toggle">Stop Devices</button><br>
        <div class="innerModule" style="display:none;">
            <button class="stopEmotibit">Stop Emotibit</button><br>
            <p class="emotibitStatus"></p>
            <button class="stopVernier">Stop Respiratory Belt</button><br>
            <p class="vernierStatus"></p>
        </div><br>

        <button class="toggle">Post Processing</button><br>
        <div class="innerModule" style="display:none;">
            <h4>Emotibit Ground Truth Data</h4>
            <p>Instructions</p>
            <ul>
                <!-- <li>Click "Convert Respiratory Data" to convert the Vernier Belt hdf5 data to csv.</li>
                <li>Click "Convert EmotiBit Data" to convert EmotiBit hdf5 data to csv.</li> -->
                <li>To import the ground truth data from the EmotiBit, first transfer the csv file from the EmotiBit SD card.</li>
                <li>Click "Import EmotiBit Data" and select the file from the location in which it was stored.</li>
                <li>Once imported, the csv file will be renamed to indicate the subject ID and copied into the subject data folder.</li>
            </ul><br>

            <!-- <button id="convertVernierData">Convert Respiratory Data</button>
            <p id="vernierProcessingStatus"></p>
            <button id="convertEmotibitData">Convert EmotiBit Data</button><br>
            <p id="postProcessingStatus"></p> -->
            <button id="openEmotibitDialog">Import EmotiBit Data</button><br>
            <input type="file" id="emotibitFileInput" style="display: none;" onchange="selectEmotibitFile(event)" /><br>
            <p id="uploadEmotibitStatus"></p>
            <p id="emotibitFilePath"></p>
        </div><br>

        <button class="toggle">Transcription and SER</button>
        <div class="innerModule" style="display:none;">
            <h4>Transcription and SER</h4>
            <p>Instructions</p>
            <ul>
                <li>Click "Process Audio" to transcribe and perform SER on all audio files for the current subject.</li>
                <li><span class="required">NOTE: </span>This process may take several minutes to complete.</li>
            </ul><br>
            <button id="processAudio">Process Audio</button><br>
            <p id="audioProcessingStatus"></p>
            <p id="audioProcessingPath"></p>
        </div>
    </div><br>

    <h2>More Tools</h2>
    <button class="toggle">Show Tools</button>
    <div class="testModule" style="display:none;">
        <button class="toggle">External Google Forms</button><br>
        <div class="innerModule" style="display:none;" disabled>
            <h4>Upload External Surveys</h4>
            <p>Instructions</p>
            <ul>
                <li>First convert Google Form responses to Google Sheet and dowload the sheet as CSV. Be sure to remember the download destination</li>
                <li>Click "Upload File", navigate to the destination folder and select the CSV.</li>
                <li>If the subject's ID or name and email are found, their survey responses will be stored in the data folder for the current ID.</li>
            </ul><br>
            <button id="openFileDialog">Upload File</button><br><br>
            <input type="file" id="fileInput" style="display: none;" onchange="selectCSVFile(event)" />
            <p id="uploadCSVstatus"></p>
            <p id="csvFilePath"></p>
        </div><br>

        <button class="toggle">Additional Surveys</button><br>
        <div class="innerModule" style="display:none;">
            <h4>Upload Blank Google Form Survey</h4>
            <p>Instructions</p>
            <ul>
                <li>Create the Google Form survey you would like to add.</li>
                <li><span class="required">IMPORTANT:</span> Include an "ID" text entry at the head of the survey.</li>
                <li>Submit the name and URL of the survey you want to add with the form below.</li>
            </ul>
            
            <form id="surveyForm" action="/upload_survey" method="POST">
                <label for="survey_name">Survey Name:</label>
                <input type="text" id="survey_name" name="survey_name" required><br><br>
                <label for="survey_url">Survey URL:</label>
                <input type="text" id="survey_url" name="survey_url" required><br><br>
                <button type="submit">Upload Survey</button>
            </form><br>
            <p id="uploadSurveyStatus"></p>

            <h4>Launch a Survey</h4>
            <p>Instructions</p>
            <ul>
                <li>Enter the name of the survey you would like to launch.</li>
                <li>If it exists in the current list, The survey will be embedded in a separate window.</li>
                <li>When the survey is launched, the subject ID will appear below.</li>
                <li>Copy the subject ID below and paste it into the ID cell of the survey</li>
            </ul><br>
            <form id="openSurvey">
                <label for="surveyName">Enter Survey Name:</label>
                <input type="text" id="surveyName" name="surveyName" required>
                <button type="submit">Open Survey</button>
            </form><br>
            <p id="subjectIDDisplay"></p>
            <p id="fetchedSurveyStatus"></p>
        </div><br>
        
        <button class="toggle">Subject Encryption</button><br>
        <div class="innerModule" style="display:none;">
            <h4>Encrypt Subject Name and Email</h4>
            <p>Instructions</p>
            <ul>
                <li>Use this to derive the obfuscated ID for a subject if you need to search the subject data files for a match.</li>
                <li>Otherwise, this algorithm runs automatically when subjects enter their information on the subject dashboard.</li>
                <li>Enter the subject's email address below.</li>
                <li>Click "Encrypt Subject" to generate a unique subject ID.</li>
            </ul>
            <form id="encryptSubject" action="/encrypt_subject" method="POST" autocomplete="off">
                <label for="email">Email:</label>
                <input type="text" id="email" name="email" required><br><br>
                <button type="submit">Encrypt Subject</button>
            </form>
            <p id="notification3" style="display:none; color: green;">Subject ID generated successfully!</p>
            <p id="errorNotification3" style="display:none; color: red;">Error generating subject ID.</p>
            <p id="encryptionStatus" style="display:none;"></p><br>
        </div><br>

        <button class="toggle">Subject Decryption</button><br>
        <div class="innerModule" style="display:none;">
            <h4>Decrypt Subject ID string</h4>
            <p>Instructions</p>
            <ul>
                <li>Use this to get the first name, last name, and email of subject if you need to search the subject data files for a match.</li>
                <li>Enter the ID string.</li>
                <li>Click "Decrypt Subject" to generate a unique subject ID.</li>
            </ul>
            <form id="decryptSubject" action="/decrypt_subject" method="POST" autocomplete="off">
                <label for="id_string">Encrypted ID String:</label>
                <input type="text" id="id_string" name="id_string" required><br><br>
                <button type="submit">Decrypt Subject</button>
            </form>
            <p id="notification4" style="display:none; color: green;">Subject name and email retrieved successfully!</p>
            <p id="errorNotification4" style="display:none; color: red;">Error getting name and email.</p>
            <p id="decryptionStatusName" style="display:none;"></p>
            <p id="decryptionStatusEmail" style="display:none;"></p>
        </div><br>
    </div><br>

    
    <h2>Shutdown</h2>
    <button class="stopServer">Shutdown Server</button>
    </div>
    <!-- <script src="/static/js/scripts.js"></script> -->
    <script>
        const audioProcessingStatus = document.getElementById('audioProcessingStatus');
        const audioProcessingPath = document.getElementById('audioProcessingPath');
        const processAudio = document.getElementById('processAudio');
        const openFileDialog = document.getElementById('openFileDialog');
        const emotibitFilePath = document.getElementById('emotibitFilePath');
        const uploadEmotibitStatus = document.getElementById('uploadEmotibitStatus');
        const biometricStatusMessage = document.getElementById('biometricStatusMessage');
        const startEmotibitButton = document.getElementById('startEmotibitButton');
        const startVernierButton = document.getElementById('startVernierButton');
        const testAudioOutput = document.getElementById('testAudioOutput');
        const encryptSubject = document.getElementById('encryptSubject');
        const decryptSubject = document.getElementById('decryptSubject');
        const decryptionStatusName = document.getElementById('decryptionStatusName');
        const decryptionStatusEmail = document.getElementById('decryptionStatusEmail');
        const encryptionStatus = document.getElementById('encryptionStatus');
        // const postProcessingStatus = document.getElementById('postProcessingStatus');   
        const launchSubjectGUI = document.getElementById('launchSubjectGUI');
        const recTaskGen1 = document.getElementById('task_1_recording');
        const recTaskGen2 = document.getElementById('task_2_recording');
        const baselineButton = document.getElementById("startBiometricBaseline");
        // const compareBaselineButtons = document.querySelectorAll('.compareToBaseline');
        const audioDevicesDropdown = document.getElementById('audioDevices');
        const notification3 = document.getElementById('notification3');
        const errorNotification3 = document.getElementById('errorNotification3');
        const notification4 = document.getElementById('notification4');
        const errorNotification4 = document.getElementById('errorNotification4');
        // const convertEmotibitData = document.getElementById('convertEmotibitData');
        // const convertVernierData = document.getElementById('convertVernierData');
        // const vernierProcessingStatus = document.getElementById('vernierProcessingStatus');
        const openEmotibitDialog = document.getElementById('openEmotibitDialog');
        const startPRSTaskButton1 = document.getElementById('startPRSTask1');
        const startPRSTaskButton2 = document.getElementById('startPRSTask2');
        // const breakInstructions1 = document.getElementById('breakInstructions1');
        // const breakInstructions2 = document.getElementById('breakInstructions2');

        const roomObservationButtons = document.querySelectorAll('.openRoomObservationTask');
        const stopServerButtons = document.querySelectorAll('.stopServer');
        const stopEmotibitButtons = document.querySelectorAll('.stopEmotibit');
        const emotibitStatus = document.querySelectorAll('.emotibitStatus');
        const stopVernierButtons = document.querySelectorAll('.stopVernier');
        const vernierStatus = document.querySelectorAll('.vernierStatus');
        const startSARTButtons = document.querySelectorAll('.SARTButton');

        const eventSource = new EventSource('/stream');
        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log("Update received:", data);
            if (data.event_type === 'task_completed' && data.task_id) {
                console.log("Task completed:", data.message);
                const taskStatusDiv = document.getElementById(data.task_id);
                if (taskStatusDiv) {
                    taskStatusDiv.style.display = "block";
                }
            } else if (data.event_type === 'status_update') {
                console.log("Status update:", data.message);
            } else if (data.event_type === 'error') {
                console.error("Error:", data.message);
                alert("Error: " + data.message);
            }
        };

        document.addEventListener('DOMContentLoaded', function(){
            startVernierButton.addEventListener('click', function(){
                vernierStatus.forEach(status => {
                    status.innerText = "Starting respiratory belt, please wait...";
                });
                fetch('/start_vernier', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    vernierStatus.forEach(status => {
                        status.innerText = data.message;
                    });
                })
                .catch(error => {
                    vernierStatus.forEach(status => {
                        status.innerText = "An error occurred.";
                    });
                });
            });

            stopVernierButtons.forEach(button => {
                button.addEventListener('click', function(){
                    fetch('/stop_vernier', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        vernierStatus.forEach(status => {
                            status.innerText = data.message;
                        });
                    })
                    .catch(error => {
                        vernierStatus.forEach(status => {
                            status.innerText = "An error occurred while stopping the respiratory belt streamer.";
                        });
                    });
                });
            });
        });
    
        openEmotibitDialog.addEventListener('click', function() {
            document.getElementById('emotibitFileInput').click();
        });

        openFileDialog.addEventListener('click', function() {
            document.getElementById('fileInput').click();
        });

        const uploadCSVstatus = document.getElementById('uploadCSVstatus');
        const csvFilePath = document.getElementById('csvFilePath');
        function selectCSVFile(event){
            const file = event.target.files[0];
            if(file){
                console.log("Selected File: ", file.name);
                const formData = new FormData();
                formData.append('csv_file', file);
                fetch('/upload_surveys_csv', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message === "Invalid file type. Only CSV files are allowed." || 
                        data.message === "Subject information is not set." ||
                        data.message === "Survey response or email column not found.") {
                        uploadCSVstatus.innerText = data.message;
                        return;
                    } else {
                        uploadCSVstatus.innerText = data.message;
                        csvFilePath.innerText = `File Path: ${data.file_path}`;
                    }
                })
                .catch(error => uploadCSVstatus.innerText = "An error occurred.");
            } else {
                uploadCSVstatus.innerText = 'No file selected.';
            }
        }

        function selectEmotibitFile(event) {
            const file = event.target.files[0];
            const formData = new FormData();
            formData.append('emotibit_file', file);
            fetch('/import_emotibit_csv', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.message) {
                    uploadEmotibitStatus.innerText = data.message;
                    uploadEmotibitStatus.style.display = "block";
                    if (data.file_path) {
                        emotibitFilePath.innerText = `EmotiBit CSV Location: ${data.file_path}`;
                    }
                } else {
                    throw new Error('Invalid response structure');
                }
            })
            .catch(error => {
                uploadEmotibitStatus.innerText = "error uploading";
                uploadEmotibitStatus.style.display = "block";
            });
        }

        processAudio.addEventListener('click', function() {
            audioProcessingStatus.innerText = "Processing audio files, this might take a while...";
            processAudioFiles(audioProcessingStatus, audioProcessingPath);
        });

        document.addEventListener("DOMContentLoaded", function () {;
            const uploadSurveyStatus = document.getElementById('uploadSurveyStatus');
            const form = document.getElementById('surveyForm');

            form.addEventListener('submit', function(event) {
                event.preventDefault();
                const formData = new FormData(form);
                fetch('/upload_survey', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    uploadSurveyStatus.innerText = data.message;
                    uploadSurveyStatus.style.display = "block";
                })
                .catch(error => {
                    uploadSurveyStatus.innerText = data.error;
                    uploadSurveyStatus.style.display = "block";
                });
            });
        });

        document.addEventListener("DOMContentLoaded", () => {
            const subjectIDDisplay = document.getElementById('subjectIDDisplay');
            const fetchedSurveyStatus = document.getElementById('fetchedSurveyStatus');
            const form = document.getElementById('openSurvey');

            form.addEventListener('submit', function(event) {
                event.preventDefault();
                const formData = new FormData(form);
                const surveyName = formData.get('surveyName');
                fetch(`/survey/${surveyName}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Survey not found');
                        }
                        return response.text();
                    })
                    .then(html => {
                        // Open the survey page in a new window if it's valid
                        const newWindow = window.open('', '_blank', 'width=800,height=600');
                        newWindow.document.write(html); // Write the HTML content into the new window
                        newWindow.document.close(); // Close the document to render the page
                        getSubjectID();
                    })
                    .catch(error => {
                        alert('An error occurred: ' + error.message);
                    }); 
            });

            function getSubjectID() {
                fetch('/get_subject_id')
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('subjectIDDisplay').innerText = `Subject ID: ${data.subject_id}`;
                    })
                    .catch(error => {
                        console.error('Error fetching subject ID:', error);
                    });
            }
        });

        document.addEventListener("DOMContentLoaded", () => {
            const form = encryptSubject;
            form.addEventListener("submit", function(event){
                event.preventDefault();
                const formData = new FormData(form);
                fetch("/encrypt_subject", {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    encryptionStatus.innerText = `Encrypted ID: ${data.message}`;
                    encryptionStatus.style.display = "block";
                    notification3.style.display = "block";
                    errorNotification3.style.display = "none";
                })
                .catch(error => {
                    notification3.style.display = "none";
                    encryptionStatus.style.display = "block";
                    encryptionStatus.innerText = `Error: ${data.error}`;
                    errorNotification3.style.display = "block";
                });
            });
        });

        document.addEventListener("DOMContentLoaded", () => {
            const form = decryptSubject;
            form.addEventListener("submit", function(event){
                event.preventDefault();
                const formData = new FormData(form);
                fetch("/decrypt_subject", {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if(data.message === 'Subject not found.'){
                        decryptionStatusName.style.display = "none";
                        decryptionStatusEmail.style.display = "none";
                        notification4.style.display = "none";
                        errorNotification4.style.display = "block";
                        errorNotification4.innerText = data.message;
                        return;
                    }

                    decryptionStatusName.innerText = `Full Name: ${data.full_name}`;
                    decryptionStatusName.style.display = "block";
                    decryptionStatusEmail.innerText = `Email: ${data.email}`;
                    decryptionStatusEmail.style.display = "block";
                    notification4.style.display = "block";
                    errorNotification4.style.display = "none";
                })
                .catch(error => {
                    notification4.style.display = "none";
                    errorNotification4.style.display = "block";
                    errorNotification4.innerText = data.error;
                    console.log(data.error);
                });
            });
        });

        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById('experimentNameForm');
            const notification = document.getElementById("notification1");
            const errorNotification = document.getElementById("errorNotification1");

            form.addEventListener("submit", function(event){
                event.preventDefault();
                console.log("Form submission intercepted!");
                const formData = new FormData(form);
                // const postSubmitMessage = document.getElementById('postSubmitMessage');
                fetch("/submit_experiment", {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'  // Ensure Flask treats this as an AJAX request
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw err; });  // Manually throw error for catch block
                    }
                    return response.json();
                })
                .then(data => {
                    notification.style.display = "block";
                    errorNotification.style.display = "none";
                    notification.innerText = data.message;
                    // postSubmitMessage.style.display = "block";
                })
                .catch(error => {
                    notification.style.display = "none";
                    errorNotification.style.display = "block";
                    errorNotification.innerText = data.error;
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            launchSubjectGUI.addEventListener('click', function() {
                window.open('/subject_gui', '_blank', 'width=1200, height=720');
            });
        });
        
        document.addEventListener('DOMContentLoaded', function(){
            startEmotibitButton.addEventListener('click', function() {
                startEmotibit();
            });

            baselineButton.addEventListener("click", function() {
                setEventMarker('biometric_baseline');
                setCondition('None');
                biometricStatusMessage.innerText = "Collecting baseline data, please wait...";
                baselineButton.disabled = true;
                
                setTimeout(function() {
                    setEventMarker('subject_idle');
                    setCondition('None');
                    baselineButton.innerText = "Start Collecting Baseline";
                    baselineButton.disabled = false;
                    biometricStatusMessage.innerText = "Baseline data collection complete.";
                }, 120000); // 2 minutes
            });

            roomObservationButtons.forEach(button => {
                button.addEventListener('click', function() {
                    window.open('/room_observation', '_blank', 'width=800, height=600');
                });
            });

            startSARTButtons.forEach(button => {
                button.addEventListener('click', function() {
                    if (this.innerText === 'Start Task') {
                        if (this.id === 'sart1') {
                            setEventMarker('sart_task_1');
                            setCondition('None');
                        } else if (this.id === 'sart2') {
                            setEventMarker('sart_task_2');
                            setCondition('None');
                        } else if (this.id === 'sart3') {
                            setEventMarker('sart_task_3');
                            setCondition('None');
                        } else if (this.id === 'sart4') {
                            setEventMarker('sart_task_4');
                            setCondition('None');
                        } else if (this.id === 'sart5') {
                            setEventMarker('sart_task_5');
                            setCondition('None');
                        } else if (this.id === 'sart6') {
                            setEventMarker('sart_task_6');
                            setCondition('None');
                        }
                        this.innerText = 'Stop Task';
                    } else {
                        setEventMarker('subject_idle');
                        this.innerText = 'Start Task';
                    }
                });
            });
      
            // startPRSTaskButtons.forEach(button => {
            //     button.addEventListener('click', function() {
            //         window.open('/prs', '_blank', 'width=800, height=600');
            //     });
            // });

            startPRSTaskButton1.addEventListener('click', function() {
                // breakInstructions1.style.display = 'block';
                window.open('/prs', '_blank', 'width=800, height=600');
            });
            startPRSTaskButton2.addEventListener('click', function() {
                // breakInstructions2.style.display = 'block';
                window.open('/prs', '_blank', 'width=800, height=600');
            });
        });

        document.addEventListener('DOMContentLoaded', (event) => {
            console.log('Fetching audio devices...');
            fetchAudioDevices();
            audioDevicesDropdown.addEventListener('change', setDevice);
        });

        document.addEventListener('DOMContentLoaded', function() {
            testAudioOutput.addEventListener('click', function() {
                let beepCount = 0;
                const interval = setInterval(function() {
                    playTestTone();
                    beepCount++;
                    if (beepCount === 3) {
                        clearInterval(interval);
                    }
                }, 1000); 
            });

            function playTestTone() {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.start();
                setTimeout(() => {
                    oscillator.stop();
                }, 500); 
            }
        });

        document.addEventListener('DOMContentLoaded', function(){
            recTaskGen1.addEventListener('click', function() {
                if (recTaskGen1.innerText == "Start Recording"){
                    recTaskGen1.innerText = "Stop Recording";
                    recordTask(recTaskGen1, 'start');
                } else {
                    recTaskGen1.innerText = "Start Recording";
                    recordTask(recTaskGen1, 'stop');
                }
            });
            
            recTaskGen2.addEventListener('click', function() {
                if (recTaskGen2.innerText == "Start Recording"){
                    recTaskGen2.innerText = "Stop Recording";
                    recordTask(recTaskGen2, 'start');
                } else {
                    recTaskGen2.innerText = "Start Recording";
                    recordTask(recTaskGen2, 'stop');
                }
            });

            function recordTask(button, action){
                const buttonId = button.id;
                const statusId1 = document.getElementById("recordingStatus1");
                const statusId2 = document.getElementById("recordingStatus2");
                console.log(`Button ID: ${buttonId}`);

                const parentDiv = button.closest('div');
                const selectedCondition = parentDiv.querySelector('select').value;
                let eventMarker = buttonId;
                let condition = selectedCondition;

                if(action === 'start') {
                    if (buttonId == 'task_1_recording'){
                        statusId1.style.display = 'block';
                        statusId1.innerText = 'Please wait...';
                    } else if (buttonId == 'task_2_recording'){
                        statusId2.style.display = 'block';
                        statusId2.innerText = 'Please wait...';
                    }
                } else {;
                    if (buttonId == 'task_1_recording'){
                        statusId1.style.display = 'block';
                        statusId1.innerText = 'Audio processing. Please wait...';
                    } else if (buttonId == 'task_2_recording'){
                        statusId2.style.display = 'block';
                        statusId2.innerText = 'Audio processing. Please wait...';
                    }
                }
                // DEBUG
                console.log(`eventMarker: ${eventMarker}, action: ${action}`); 

                fetch('/record_task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event_marker: eventMarker,
                        condition: condition,
                        action: action
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if(buttonId == 'task_1_recording'){
                        statusId1.style.display = 'block';
                        statusId1.innerText = data.message;
                    } else if (buttonId == 'task_2_recording'){
                        statusId2.style.display = 'block';
                        statusId2.innerText = data.message;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if(buttonId == 'task_1_recording'){
                        statusId1.style.display = 'block';
                        statusId1.innerText = data.message;
                    } else if (buttonId == 'task_2_recording'){
                        statusId2.style.display = 'block';
                        statusId2.innerText = data.message;
                    }
                });
                if (action === 'start'){
                    playBeep();
                }
            }

            stopServerButtons.forEach(button => {
                button.addEventListener('click', function() {
                    fetch('/shutdown', {
                        method: 'POST'
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(data.message);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                });
            });

            stopEmotibitButtons.forEach(button => {
                button.addEventListener('click', function() {
                    fetch('/stop_emotibit', {
                        method: 'POST'
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        emotibitStatus.forEach(status => {
                            status.innerText = data.message;
                        });
                        console.log(data.message);
                    })
                    .catch(error => {
                        emotibitStatus.forEach(status => {
                            status.innerText = error.message || "An error occurred.";
                        });
                        console.error('Error:', error);
                    });
                });
            });
        });
    </script>
</body>
</html>